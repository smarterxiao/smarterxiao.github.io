<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="进阶,Android开发艺术探索," />










<meta name="description" content="第五章 理解RemoteViews本章讲述的主题是remoteView。可以从名字可以看出是一种远程View。那么什么是远程View呢?主要有两种一个是通知栏，一个是桌面小插件 RemoteViews的应用RemoteView在实际开发过程中主要用于通知栏和桌面小组件的开发。通知栏大家都不陌生，主要是通过使用NotificationManager来实现。除了默认布局，还可以自定义布局。桌面小部件则">
<meta name="keywords" content="进阶,Android开发艺术探索">
<meta property="og:type" content="article">
<meta property="og:title" content="Android开发艺术探索 第五章 理解RemoteViews">
<meta property="og:url" content="http://yoursite.com/android/Android开发艺术探索_第五章 理解RemoteViews/index.html">
<meta property="og:site_name" content="个人网站">
<meta property="og:description" content="第五章 理解RemoteViews本章讲述的主题是remoteView。可以从名字可以看出是一种远程View。那么什么是远程View呢?主要有两种一个是通知栏，一个是桌面小插件 RemoteViews的应用RemoteView在实际开发过程中主要用于通知栏和桌面小组件的开发。通知栏大家都不陌生，主要是通过使用NotificationManager来实现。除了默认布局，还可以自定义布局。桌面小部件则">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/android/Android开发艺术探索_第五章%20理解RemoteViews/device-2018-05-01-093823.png">
<meta property="og:image" content="http://yoursite.com/android/Android开发艺术探索_第五章%20理解RemoteViews/device-2018-05-01-095037.png">
<meta property="og:image" content="http://yoursite.com/android/Android开发艺术探索_第五章%20理解RemoteViews/图像1525593096.png">
<meta property="og:updated_time" content="2018-07-26T13:02:16.565Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android开发艺术探索 第五章 理解RemoteViews">
<meta name="twitter:description" content="第五章 理解RemoteViews本章讲述的主题是remoteView。可以从名字可以看出是一种远程View。那么什么是远程View呢?主要有两种一个是通知栏，一个是桌面小插件 RemoteViews的应用RemoteView在实际开发过程中主要用于通知栏和桌面小组件的开发。通知栏大家都不陌生，主要是通过使用NotificationManager来实现。除了默认布局，还可以自定义布局。桌面小部件则">
<meta name="twitter:image" content="http://yoursite.com/android/Android开发艺术探索_第五章%20理解RemoteViews/device-2018-05-01-093823.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/android/Android开发艺术探索_第五章 理解RemoteViews/"/>





  <title>Android开发艺术探索 第五章 理解RemoteViews | 个人网站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人网站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/android/Android开发艺术探索_第五章 理解RemoteViews/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Groot">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人网站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android开发艺术探索 第五章 理解RemoteViews</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-27T17:08:26+08:00">
                2018-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>第五章 理解RemoteViews<br>本章讲述的主题是remoteView。可以从名字可以看出是一种远程View。那么什么是远程View呢?主要有两种一个是通知栏，一个是桌面小插件</p>
<h1 id="RemoteViews的应用"><a href="#RemoteViews的应用" class="headerlink" title="RemoteViews的应用"></a>RemoteViews的应用</h1><p>RemoteView在实际开发过程中主要用于通知栏和桌面小组件的开发。通知栏大家都不陌生，主要是通过使用NotificationManager来实现。除了默认布局，还可以自定义布局。桌面小部件则通过AppWidgetProvide来实现。AppWidgetProvide本质上是一个广播。在开发RemoteView的过程中会用到RemoteViews。他们更新界面不能像在Activity中那样更新，因为二者的界面都运行在其他进程中，准确的说是SystemServer中，为了更新UI，这里提供了一系列更新的方法。所以这里会简单介绍一下用法，重点是讲解一下RemoteView的内在机制</p>
<h2 id="RemoteView在通知栏的应用"><a href="#RemoteView在通知栏的应用" class="headerlink" title="RemoteView在通知栏的应用"></a>RemoteView在通知栏的应用</h2><p>首先看一下RemoteView在通知栏的使用。我们知道，通知栏除了默认效果以外，还可以支持自定义布局。下面分别说一下这两种情况。使用系统默认的样式弹出一个通知是很简单的，代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E/NotificationService: No Channel found for pkg=com.smart.kaifa, channelId=100, id=1000000, tag=null, opPkg=com.smart.kaifa, callingUid=10190, userId=0, incomingUserId=0, notificationUid=10190, notification=Notification(channel=100 pri=0 contentView=null vibrate=null sound=null defaults=0x0 flags=0x0 color=0x00000000 vis=PRIVATE)</span><br></pre></td></tr></table></figure></p>
<p>在使用的时候遇到了这个问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//获取NotificationManager实例</span><br><span class="line">   NotificationManager notifyManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">   Intent intent = new Intent(this, SecondActivity.class);</span><br><span class="line"></span><br><span class="line">   PendingIntent pendingIntent = PendingIntent.getActivity(this, 9, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span><br><span class="line">   //实例化NotificationCompat.Builde并设置相关属性</span><br><span class="line">   NotificationCompat.Builder builder = new NotificationCompat.Builder(this, 100 + &quot;&quot;)</span><br><span class="line">           //设置小图标</span><br><span class="line">           .setSmallIcon(R.mipmap.ic_launcher)</span><br><span class="line">           //设置通知标题</span><br><span class="line">           .setContentTitle(&quot;最简单的Notification&quot;)</span><br><span class="line">           .setOngoing(true)</span><br><span class="line">           //设置通知内容</span><br><span class="line">           .setContentText(&quot;只有小图标、标题、内容&quot;).setContentIntent(pendingIntent)</span><br><span class="line">           //设置通知时间，默认为系统发出通知的时间，通常不用设置</span><br><span class="line">           .setWhen(System.currentTimeMillis());</span><br><span class="line">   //通过builder.build()方法生成Notification对象,并发送通知,id=1</span><br><span class="line">   notifyManager.notify(1000000, builder.build());</span><br></pre></td></tr></table></figure></p>
<p>这个是因为在android 8.0及以上改变了通知，要设置channelId。<br><a href="https://stackoverflow.com/questions/46990995/on-android-8-1-api-27-notification-does-not-display" target="_blank" rel="noopener">https://stackoverflow.com/questions/46990995/on-android-8-1-api-27-notification-does-not-display</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">private NotificationManager notifManager;</span><br><span class="line"></span><br><span class="line">    public void createNotification(String aMessage) &#123;</span><br><span class="line">        final int NOTIFY_ID = 1002;</span><br><span class="line"></span><br><span class="line">        // There are hardcoding only for show it&apos;s just strings</span><br><span class="line">        String name = &quot;my_package_channel&quot;;</span><br><span class="line">        String id = &quot;my_package_channel_1&quot;; // The user-visible name of the channel.</span><br><span class="line">        String description = &quot;my_package_first_channel&quot;; // The user-visible description of the channel.</span><br><span class="line"></span><br><span class="line">        Intent intent;</span><br><span class="line">        PendingIntent pendingIntent;</span><br><span class="line">        NotificationCompat.Builder builder;</span><br><span class="line"></span><br><span class="line">        if (notifManager == null) &#123;</span><br><span class="line">            notifManager =</span><br><span class="line">                    (NotificationManager)getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">            int importance = NotificationManager.IMPORTANCE_HIGH;</span><br><span class="line">            NotificationChannel mChannel = notifManager.getNotificationChannel(id);</span><br><span class="line">            if (mChannel == null) &#123;</span><br><span class="line">                mChannel = new NotificationChannel(id, name, importance);</span><br><span class="line">                mChannel.setDescription(description);</span><br><span class="line">                mChannel.enableVibration(true);</span><br><span class="line">                mChannel.setVibrationPattern(new long[]&#123;100, 200, 300, 400, 500, 400, 300, 200, 400&#125;);</span><br><span class="line">                notifManager.createNotificationChannel(mChannel);</span><br><span class="line">            &#125;</span><br><span class="line">            builder = new NotificationCompat.Builder(this, id);</span><br><span class="line"></span><br><span class="line">            intent = new Intent(this, MainActivity.class);</span><br><span class="line">            intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">            pendingIntent = PendingIntent.getActivity(this, 0, intent, 0);</span><br><span class="line"></span><br><span class="line">            builder.setContentTitle(aMessage)  // required</span><br><span class="line">                    .setSmallIcon(android.R.drawable.ic_popup_reminder) // required</span><br><span class="line">                    .setContentText(this.getString(R.string.app_name))  // required</span><br><span class="line">                    .setDefaults(Notification.DEFAULT_ALL)</span><br><span class="line">                    .setAutoCancel(true)</span><br><span class="line">                    .setContentIntent(pendingIntent)</span><br><span class="line">                    .setTicker(aMessage)</span><br><span class="line">                    .setVibrate(new long[]&#123;100, 200, 300, 400, 500, 400, 300, 200, 400&#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line"></span><br><span class="line">            builder = new NotificationCompat.Builder(this);</span><br><span class="line"></span><br><span class="line">            intent = new Intent(this, MainActivity.class);</span><br><span class="line">            intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">            pendingIntent = PendingIntent.getActivity(this, 0, intent, 0);</span><br><span class="line"></span><br><span class="line">            builder.setContentTitle(aMessage)                           // required</span><br><span class="line">                    .setSmallIcon(android.R.drawable.ic_popup_reminder) // required</span><br><span class="line">                    .setContentText(this.getString(R.string.app_name))  // required</span><br><span class="line">                    .setDefaults(Notification.DEFAULT_ALL)</span><br><span class="line">                    .setAutoCancel(true)</span><br><span class="line">                    .setContentIntent(pendingIntent)</span><br><span class="line">                    .setTicker(aMessage)</span><br><span class="line">                    .setVibrate(new long[]&#123;100, 200, 300, 400, 500, 400, 300, 200, 400&#125;)</span><br><span class="line">                    .setPriority(Notification.PRIORITY_HIGH);</span><br><span class="line">        &#125; // else if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line"></span><br><span class="line">        Notification notification = builder.build();</span><br><span class="line">        notifManager.notify(NOTIFY_ID, notification);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这样就可以使用penddingIntent打开SecondActivity了。</p>
<p><img src="device-2018-05-01-093823.png" alt="Alt text" title="Android 原生8.0弹出的默认样式的通知"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private NotificationManager notifManager;</span><br><span class="line"></span><br><span class="line">public void createNotification(String aMessage) &#123;</span><br><span class="line">    final int NOTIFY_ID = 1002;</span><br><span class="line"></span><br><span class="line">    // There are hardcoding only for show it&apos;s just strings</span><br><span class="line">    String name = &quot;my_package_channel&quot;;</span><br><span class="line">    String id = &quot;my_package_channel_1&quot;; // The user-visible name of the channel.</span><br><span class="line">    String description = &quot;my_package_first_channel&quot;; // The user-visible description of the channel.</span><br><span class="line"></span><br><span class="line">    Intent intent;</span><br><span class="line">    PendingIntent pendingIntent;</span><br><span class="line">    NotificationCompat.Builder builder;</span><br><span class="line"></span><br><span class="line">    if (notifManager == null) &#123;</span><br><span class="line">        notifManager =</span><br><span class="line">                (NotificationManager)getSystemService(Context.NOTIFICATION_SERVICE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">        int importance = NotificationManager.IMPORTANCE_HIGH;</span><br><span class="line">        NotificationChannel mChannel = notifManager.getNotificationChannel(id);</span><br><span class="line">        if (mChannel == null) &#123;</span><br><span class="line">            mChannel = new NotificationChannel(id, name, importance);</span><br><span class="line">            mChannel.setDescription(description);</span><br><span class="line">            mChannel.enableVibration(true);</span><br><span class="line">            mChannel.setVibrationPattern(new long[]&#123;100, 200, 300, 400, 500, 400, 300, 200, 400&#125;);</span><br><span class="line">            notifManager.createNotificationChannel(mChannel);</span><br><span class="line">        &#125;</span><br><span class="line">        builder = new NotificationCompat.Builder(this, id);</span><br><span class="line"></span><br><span class="line">        intent = new Intent(this, MainActivity.class);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">        pendingIntent = PendingIntent.getActivity(this, 0, intent, 0);</span><br><span class="line">        RemoteViews remoteViews=new RemoteViews(getPackageName(),R.layout.notification_compat_remote);</span><br><span class="line"></span><br><span class="line">        remoteViews.setTextViewText(R.id.tv_first,&quot;帅气&quot;);</span><br><span class="line">        remoteViews.setTextViewText(R.id.tv_second,&quot;英俊&quot;);</span><br><span class="line">        remoteViews.setOnClickPendingIntent(R.id.tv_second,pendingIntent);</span><br><span class="line">        builder.setContentTitle(aMessage)  // required</span><br><span class="line">                .setSmallIcon(android.R.drawable.ic_popup_reminder) // required</span><br><span class="line">                .setContentText(this.getString(R.string.app_name))  // required</span><br><span class="line">                .setDefaults(Notification.DEFAULT_ALL)</span><br><span class="line">                .setAutoCancel(true)</span><br><span class="line">                .setContentIntent(pendingIntent)</span><br><span class="line">                .setTicker(aMessage).setContent(remoteViews)</span><br><span class="line">                .setVibrate(new long[]&#123;100, 200, 300, 400, 500, 400, 300, 200, 400&#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        builder = new NotificationCompat.Builder(this);</span><br><span class="line"></span><br><span class="line">        intent = new Intent(this, MainActivity.class);</span><br><span class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">        pendingIntent = PendingIntent.getActivity(this, 0, intent, 0);</span><br><span class="line"></span><br><span class="line">        builder.setContentTitle(aMessage)                           // required</span><br><span class="line">                .setSmallIcon(android.R.drawable.ic_popup_reminder) // required</span><br><span class="line">                .setContentText(this.getString(R.string.app_name))  // required</span><br><span class="line">                .setDefaults(Notification.DEFAULT_ALL)</span><br><span class="line">                .setAutoCancel(true)</span><br><span class="line">                .setContentIntent(pendingIntent)</span><br><span class="line">                .setTicker(aMessage)</span><br><span class="line">                .setVibrate(new long[]&#123;100, 200, 300, 400, 500, 400, 300, 200, 400&#125;)</span><br><span class="line">                .setPriority(Notification.PRIORITY_HIGH);</span><br><span class="line">    &#125; // else if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line"></span><br><span class="line">    Notification notification = builder.build();</span><br><span class="line">    notifManager.notify(NOTIFY_ID, notification);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tv_first&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        android:layout_weight=&quot;1&quot;</span><br><span class="line">        android:background=&quot;#00ff00&quot; /&gt;</span><br><span class="line">    &lt;TextView</span><br><span class="line">        android:id=&quot;@+id/tv_second&quot;</span><br><span class="line">        android:layout_width=&quot;0dp&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        android:layout_weight=&quot;1&quot;</span><br><span class="line">        android:background=&quot;#ff00ff&quot; /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p><img src="device-2018-05-01-095037.png" alt="Alt text" title="一个自定义的通知"><br>虽然不好看，但是效果有了就可以<br>RemoteViews使用起来是很简单的，只要提供当前应用的包名和布局文件资源的id就可以创建一个RemoteViews对象了。这里由于RemoteViews是显示在其他进程中的，所以只能使用它提供的set方法修改布局的内容。来看一下上面的<code>setTextViewText</code>这个方法。设置imageView也是类似的。</p>
<h2 id="RemoteViews在桌面小部件的应用"><a href="#RemoteViews在桌面小部件的应用" class="headerlink" title="RemoteViews在桌面小部件的应用"></a>RemoteViews在桌面小部件的应用</h2><p>AppWidgetProvide是Android提供的用于实现桌面小部件的类。其本质是一个广播：broadcaskReceiver。可以看一下他的继承关系：在AndroidStudio中双击Shift -&gt;AppWidgetProvider -&gt;然后 ctrl+h 就可以看到他的继承关系了.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class AppWidgetProvider extends BroadcastReceiver &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面来写一个小Demo来测试一下</p>
<ol>
<li>定义小部件界面</li>
</ol>
<p>在res/layout 下新建一个XML文件，命名为widget.xml，名称和内容可以自定义。看这个小部件的样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout</span><br><span class="line">    android:orientation=&quot;vertical&quot;</span><br><span class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ImageView</span><br><span class="line">        android:id=&quot;@+id/imageView1&quot;</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:src=&quot;@mipmap/ic_launcher&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p>然后在res/xml下面新建一个XML文件<code>appwidget_provide_info</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;appwidget-provider xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:initialKeyguardLayout=&quot;@layout/widget&quot;</span><br><span class="line">    android:minHeight=&quot;84dp&quot;</span><br><span class="line">    android:minWidth=&quot;84dp&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;</span><br><span class="line">    //这个是自动更新周期</span><br><span class="line">    android:updatePeriodMillis=&quot;864000000&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;/appwidget-provider&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里发现一个问题在android8.0上由于取消了隐式广播，所以如果要使用隐式广播会报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BroadcastQueue: Background execution not allowed: receiving Intent</span><br></pre></td></tr></table></figure></p>
<p>解决方案使用明确的广播</p>
<p>这里还有一个问题就是<code>bitmap = BitmapFactory.decodeResource(context.getResources(), vectorDrawableId);</code>会在5.0以上返回null,这里可以看一下如何处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private static Bitmap getBitmap(Context context,int vectorDrawableId) &#123;</span><br><span class="line">    Bitmap bitmap=null;</span><br><span class="line">    if (Build.VERSION.SDK_INT&gt; Build.VERSION_CODES.LOLLIPOP)&#123;</span><br><span class="line">        Drawable vectorDrawable = context.getDrawable(vectorDrawableId);</span><br><span class="line">        bitmap = Bitmap.createBitmap(vectorDrawable.getIntrinsicWidth(),</span><br><span class="line">                vectorDrawable.getIntrinsicHeight(), Bitmap.Config.ARGB_8888);</span><br><span class="line">        Canvas canvas = new Canvas(bitmap);</span><br><span class="line">        vectorDrawable.setBounds(0, 0, canvas.getWidth(), canvas.getHeight());</span><br><span class="line">        vectorDrawable.draw(canvas);</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        bitmap = BitmapFactory.decodeResource(context.getResources(), vectorDrawableId);</span><br><span class="line">    &#125;</span><br><span class="line">    return bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">public class AppEidgetProvider extends AppWidgetProvider &#123;</span><br><span class="line"></span><br><span class="line">    public static final String TAG = &quot;AppEidgetProvider&quot;;</span><br><span class="line">    public static final String CLICK_ACTION = &quot;com.smart.kaifa111&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 这个是广播的内置方法，具体操作交给其他的东西</span><br><span class="line">     *</span><br><span class="line">     * @param context</span><br><span class="line">     * @param intent</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onReceive(final Context context, Intent intent) &#123;</span><br><span class="line">        super.onReceive(context, intent);</span><br><span class="line">        Log.i(&quot;输出&quot;, &quot;action: &quot; + CLICK_ACTION);</span><br><span class="line">        Log.i(&quot;输出&quot;, &quot;action: ---------------------&quot; );</span><br><span class="line">        Log.i(&quot;输出&quot;, &quot;action: &quot; + intent.getAction());</span><br><span class="line"></span><br><span class="line">        if (intent.getAction().equals(CLICK_ACTION)) &#123;</span><br><span class="line">            Toast.makeText(context, &quot;click it&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">            new Thread(new Runnable() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void run() &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    AppWidgetManager appWidgetManager = AppWidgetManager.getInstance(context);</span><br><span class="line">                    for (int i = 0; i &lt; 37; i++) &#123;</span><br><span class="line">                        float degree = (i * 10) % 360;</span><br><span class="line">                        RemoteViews remoteViews = new RemoteViews(context.getPackageName(), R.layout.widget);</span><br><span class="line">                        remoteViews.setImageViewBitmap(R.id.imageView1, remoteBitmap(context, getBitmap(context,R.mipmap.ic_launcher), degree));</span><br><span class="line">                        // 声明明确的广播  vs     Intent intentClick = new Intent();</span><br><span class="line">                        Intent intentClick = new Intent(context,AppEidgetProvider.class);</span><br><span class="line">                        intentClick.setAction(CLICK_ACTION);</span><br><span class="line">                        PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intentClick, 0);</span><br><span class="line">                        remoteViews.setOnClickPendingIntent(R.id.imageView1, pendingIntent);</span><br><span class="line">                        appWidgetManager.updateAppWidget(new ComponentName(context, AppEidgetProvider.class), remoteViews);</span><br><span class="line">                        SystemClock.sleep(30);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static Bitmap getBitmap(Context context,int vectorDrawableId) &#123;</span><br><span class="line">        Bitmap bitmap=null;</span><br><span class="line">        if (Build.VERSION.SDK_INT&gt; Build.VERSION_CODES.LOLLIPOP)&#123;</span><br><span class="line">            Drawable vectorDrawable = context.getDrawable(vectorDrawableId);</span><br><span class="line">            bitmap = Bitmap.createBitmap(vectorDrawable.getIntrinsicWidth(),</span><br><span class="line">                    vectorDrawable.getIntrinsicHeight(), Bitmap.Config.ARGB_8888);</span><br><span class="line">            Canvas canvas = new Canvas(bitmap);</span><br><span class="line">            vectorDrawable.setBounds(0, 0, canvas.getWidth(), canvas.getHeight());</span><br><span class="line">            vectorDrawable.draw(canvas);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            bitmap = BitmapFactory.decodeResource(context.getResources(), vectorDrawableId);</span><br><span class="line">        &#125;</span><br><span class="line">        return bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * 每删除一次窗口小部件，就调用一次</span><br><span class="line">     *</span><br><span class="line">     * @param context</span><br><span class="line">     * @param appWidgetIds</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onDeleted(Context context, int[] appWidgetIds) &#123;</span><br><span class="line">        super.onDeleted(context, appWidgetIds);</span><br><span class="line">        Log.i(&quot;onDeleted&quot;, &quot;action: &quot; + CLICK_ACTION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 小部件第一次创建时调用</span><br><span class="line">     *</span><br><span class="line">     * @param context</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onEnabled(Context context) &#123;</span><br><span class="line">        super.onEnabled(context);</span><br><span class="line">        Log.i(&quot;onEnabled&quot;, &quot;action: &quot; + CLICK_ACTION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 当最后一个窗口小部件被删除时，调用此方法</span><br><span class="line">     *</span><br><span class="line">     * @param context</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onDisabled(Context context) &#123;</span><br><span class="line">        super.onDisabled(context);</span><br><span class="line">        Log.i(&quot;onDeleted&quot;, &quot;action: &quot; + CLICK_ACTION);</span><br><span class="line"></span><br><span class="line">        Log.i(&quot;onDeleted&quot;, &quot;action: &quot; + CLICK_ACTION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 每次桌面小部件更新时都调用一次该方法</span><br><span class="line">     *</span><br><span class="line">     * @param context</span><br><span class="line">     * @param appWidgetManager</span><br><span class="line">     * @param appWidgetIds</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds) &#123;</span><br><span class="line">        super.onUpdate(context, appWidgetManager, appWidgetIds);</span><br><span class="line">        Log.i(&quot;更新&quot;, &quot;action: &quot; + CLICK_ACTION);</span><br><span class="line">        final int counter = appWidgetIds.length;</span><br><span class="line">        for (int i = 0; i &lt; counter; i++) &#123;</span><br><span class="line">            int appWidgetId = appWidgetIds[i];</span><br><span class="line">            onWidgetUpdate(context, appWidgetManager, appWidgetId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private void onWidgetUpdate(Context context, AppWidgetManager manager, int appWidgetId) &#123;</span><br><span class="line"></span><br><span class="line">        Log.i(TAG, &quot;appWidgetId =&quot; + appWidgetId);</span><br><span class="line">        RemoteViews remoteViews = new RemoteViews(context.getPackageName(), R.layout.widget);</span><br><span class="line">        Intent intentClick = new Intent(context,AppEidgetProvider.class);</span><br><span class="line">        intentClick.setAction(CLICK_ACTION);</span><br><span class="line">        PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intentClick, 0);</span><br><span class="line">        remoteViews.setOnClickPendingIntent(R.id.imageView1, pendingIntent);</span><br><span class="line">        manager.updateAppWidget(appWidgetId, remoteViews);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Bitmap remoteBitmap(Context context, Bitmap srcbBitmap, float degree) &#123;</span><br><span class="line"></span><br><span class="line">        Matrix matrix = new Matrix();</span><br><span class="line">        matrix.reset();</span><br><span class="line">        matrix.setRotate(degree);</span><br><span class="line">        Bitmap tempBitmap = Bitmap.createBitmap(srcbBitmap, 0, 0, srcbBitmap.getWidth(), srcbBitmap.getHeight(), matrix, true);</span><br><span class="line">        return tempBitmap;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>清单文件配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;receiver android:name=&quot;.AppEidgetProvider&quot;&gt;</span><br><span class="line">           &lt;intent-filter&gt;</span><br><span class="line">               &lt;action android:name=&quot;com.smart.kaifa111&quot; /&gt;</span><br><span class="line">               &lt;action android:name=&quot;android.appwidget.action.APPWIDGET_UPDATE&quot;/&gt;</span><br><span class="line">               &lt;action android:name=&quot;android.appwidget.action.APPWIDGET_UPDATE_OPTIONS&quot;/&gt;</span><br><span class="line">               &lt;action android:name=&quot;android.appwidget.action.APPWIDGET_RESTORED&quot;/&gt;</span><br><span class="line">               &lt;action android:name=&quot;android.appwidget.action.APPWIDGET_DELETED&quot;/&gt;</span><br><span class="line">           &lt;/intent-filter&gt;</span><br><span class="line"></span><br><span class="line">           &lt;meta-data</span><br><span class="line">               android:name=&quot;android.appwidget.provider&quot;</span><br><span class="line">               android:resource=&quot;@xml/appwidget_provide_info&quot; /&gt;</span><br><span class="line">       &lt;/receiver&gt;</span><br></pre></td></tr></table></figure></p>
<p>appwidget_provide_info.xml 在res/xml 下面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;appwidget-provider xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:initialKeyguardLayout=&quot;@layout/widget&quot;</span><br><span class="line">    android:minHeight=&quot;84dp&quot;</span><br><span class="line">    android:minWidth=&quot;84dp&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;</span><br><span class="line">    android:updatePeriodMillis=&quot;864000000&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;/appwidget-provider&gt;</span><br></pre></td></tr></table></figure></p>
<p>widget.xml  在res/layout下面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;LinearLayout</span><br><span class="line">    android:orientation=&quot;vertical&quot;</span><br><span class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ImageView</span><br><span class="line">        android:id=&quot;@+id/imageView1&quot;</span><br><span class="line">        android:background=&quot;#ff0000&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:src=&quot;@mipmap/ic_launcher&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里来看一下AppWidgetProvider的<code>onReceive</code>的源码和具体的分发过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">     // Protect against rogue update broadcasts (not really a security issue,</span><br><span class="line">     // just filter bad broacasts out so subclasses are less likely to crash).</span><br><span class="line">     String action = intent.getAction();</span><br><span class="line">     //判断不同的action，进行条件删选，并且调用方法</span><br><span class="line">     if (AppWidgetManager.ACTION_APPWIDGET_UPDATE.equals(action)) &#123;</span><br><span class="line">         Bundle extras = intent.getExtras();</span><br><span class="line">         if (extras != null) &#123;</span><br><span class="line">             int[] appWidgetIds = extras.getIntArray(AppWidgetManager.EXTRA_APPWIDGET_IDS);</span><br><span class="line">             if (appWidgetIds != null &amp;&amp; appWidgetIds.length &gt; 0) &#123;</span><br><span class="line">                 this.onUpdate(context, AppWidgetManager.getInstance(context), appWidgetIds);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else if (AppWidgetManager.ACTION_APPWIDGET_DELETED.equals(action)) &#123;</span><br><span class="line">         Bundle extras = intent.getExtras();</span><br><span class="line">         if (extras != null &amp;&amp; extras.containsKey(AppWidgetManager.EXTRA_APPWIDGET_ID)) &#123;</span><br><span class="line">             final int appWidgetId = extras.getInt(AppWidgetManager.EXTRA_APPWIDGET_ID);</span><br><span class="line">             this.onDeleted(context, new int[] &#123; appWidgetId &#125;);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else if (AppWidgetManager.ACTION_APPWIDGET_OPTIONS_CHANGED.equals(action)) &#123;</span><br><span class="line">         Bundle extras = intent.getExtras();</span><br><span class="line">         if (extras != null &amp;&amp; extras.containsKey(AppWidgetManager.EXTRA_APPWIDGET_ID)</span><br><span class="line">                 &amp;&amp; extras.containsKey(AppWidgetManager.EXTRA_APPWIDGET_OPTIONS)) &#123;</span><br><span class="line">             int appWidgetId = extras.getInt(AppWidgetManager.EXTRA_APPWIDGET_ID);</span><br><span class="line">             Bundle widgetExtras = extras.getBundle(AppWidgetManager.EXTRA_APPWIDGET_OPTIONS);</span><br><span class="line">             this.onAppWidgetOptionsChanged(context, AppWidgetManager.getInstance(context),</span><br><span class="line">                     appWidgetId, widgetExtras);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else if (AppWidgetManager.ACTION_APPWIDGET_ENABLED.equals(action)) &#123;</span><br><span class="line">         this.onEnabled(context);</span><br><span class="line">     &#125; else if (AppWidgetManager.ACTION_APPWIDGET_DISABLED.equals(action)) &#123;</span><br><span class="line">         this.onDisabled(context);</span><br><span class="line">     &#125; else if (AppWidgetManager.ACTION_APPWIDGET_RESTORED.equals(action)) &#123;</span><br><span class="line">         Bundle extras = intent.getExtras();</span><br><span class="line">         if (extras != null) &#123;</span><br><span class="line">             int[] oldIds = extras.getIntArray(AppWidgetManager.EXTRA_APPWIDGET_OLD_IDS);</span><br><span class="line">             int[] newIds = extras.getIntArray(AppWidgetManager.EXTRA_APPWIDGET_IDS);</span><br><span class="line">             if (oldIds != null &amp;&amp; oldIds.length &gt; 0) &#123;</span><br><span class="line">                 this.onRestored(context, oldIds, newIds);</span><br><span class="line">                 this.onUpdate(context, AppWidgetManager.getInstance(context), newIds);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>还是很简单的。</p>
<h2 id="PendingIntent的概述"><a href="#PendingIntent的概述" class="headerlink" title="PendingIntent的概述"></a>PendingIntent的概述</h2><p>前面多次提及pendingIntent，那么他是一个什么东西呢？他和Intent的区别是什么呢？</p>
<ol>
<li>先看一下他们的继承关系</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public final class PendingIntent implements Parcelable &#123;&#125;</span><br><span class="line">public class Intent implements Parcelable, Cloneable &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到都是继承自Parcelable这个类。而这个类我们很熟悉，是android用于信息传递的或者说信息序列化的,Parcelable的中文意思是打包… 还是要学好英语啊</p>
<ol start="2">
<li>PendingIntent 顾名思义，他是一种处于pending状态的intent，就是将要发生的意图。可以拆开有道一下。从这里可以看到PendingIntent是一种在将来某一个时刻发生的Intent，而Intent是立即发生</li>
<li>PendingIntent典型的使用场景是给RemoteViews添加点击事件，因为RemoteViews是运行在远程进程中的，所以无法通过setOnClickListener来设置点击事件。要设置RemoteViews中的点击事件，就必须使用PendingIntent，PendingIntent通过send和cancel方法来发送和取消特定的待定的Intent。<br>PendingIntent支持三种特定意图：启动Activity、启动Service和发送广播</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">getActivity(Context context,int requestCode,int flags)</td>
<td style="text-align:center">获取一个PendingIntent，该特定意图发生时相当于startActivity</td>
</tr>
<tr>
<td style="text-align:center">getService(Context context,int requestCode,int flags)</td>
<td style="text-align:center">获取一个PendingIntent，该特定意图发生时相当于startService</td>
</tr>
<tr>
<td style="text-align:center">getBroadCast(Context context,int requestCode,int flags)</td>
<td style="text-align:center">获取一个PendingIntent，该特定意图发生时相当于sendBroadCask</td>
</tr>
</tbody>
</table>
<p>上面第一个参数比较好理解，主要说一下第二个参数和第三个参数。<br>requestCode表示PendingIntent的请求码，多数情况下设定为0就可以了，另外requestCode会影响到flags的效果。flags常见的类型有FLAG_ONE_SHOT,FLAG_NO_CREATE,FLAG_CANCEL_CURRENT和FLAG_UPDATE_CURRENT。这里需要明白一个概念，这个就是Pending的匹配规则。即在什么情况下两个pendingIntent是相同的。<br>PendingIntent的匹配规则是：如果两个PendingIntent他们内部的Intent相同，并且requestCode也相同，那么这两个PendingIntent就相同。resultCode这个比较好理解，那么如何确定两个Intent是相同的呢。Intent的匹配规则就是ComponentName和intent-filter都相同。只要ComponentName和intent-filter是相同的，即时他的Extras不同，那么这两个Intent也是相同的。<br>不同flags的含义</p>
<ul>
<li>FLAG_ONE_SHOT<br>当前描述的PendingIntent只能被使用一次，然后他就会被自动cancel。如果后续还有相同的PendingIntent，那么他们的send方法就会调用失败。对于通知栏消息来说，如果采用此标记位。那么同类的通知只能使用一次，后续的通知单击后将无法打开。</li>
<li>FLAG_NO_CREATE<br>当前描述的Pending不会主动创建，如果当前的PendingIntent之前不存在，那么getActivity，getService，getBroadCast方法会直接返回null，即获取PendingIntent失败。这个标记位很少见，他无法单独使用，在开发中没有太多的意义</li>
<li>FLAG_CANCEL_CURRENT<br>当前描述的PendingIntent如果已经存在，那么他们都会被cancel，然后系统会创建一个新的PendingIntent。对于通知栏消息来说，那些cancel的消息单击后无法打开</li>
<li>FLAG_UPDATE_CURRENT<br>当前描述的PendingIntent如果已经存在，那么他们都会被更新，即他们的Intent中的Extras会被替换成最新<br>从上面的分析来讲，还是不是非常好理解这四个标记位<br>这里在结合通知栏消息在描述一遍。<br><code>Manager.notify(1,nootification)</code>如果notifi的第一个参数id是常量，那么多次调用notify只能弹出一个通知，后续的通知会把前面的通知完全替代掉，而如果每一次的id都不同，那么多次调用notify会弹出多个通知。如果notify方法中的id是常量，那么不管pendingIntent是否匹配，后面的通知会直接替换前面的通知。<br>如果notify方法的id每一次都不一样，那么当pendingIntent不匹配时，这里的匹配规则指的是PendingIntent中的Intent相同并且requestCode相同，这种情况下不管采用什么标记位，这些通知都不会互相干扰。如果pendingIntent处于匹配状态时，这个时候要分情况讨论，如果采用FLAG_ONE_SHOT标记位，那么后续的通知中的PendingIntent会和第一条通知保持一致，如果其中包含Extras，单击任何一条通知后，剩余的通知将无法打开，当所有的通知被清除后，又会重复这个过程。如果采用FLAG_CANCEL_CURRENT标记位，那么只有最新的通知可以打开，之前弹出的通知都无法打开；如果使用FLAG_UPDATE_CURRENT，那么之前通知中用的PendingIntent会被更新和最新的一条保持一致，包括其中的Extras，并且这些通知都是可以打开的</li>
</ul>
<h1 id="RemoteViews的内部机制"><a href="#RemoteViews的内部机制" class="headerlink" title="RemoteViews的内部机制"></a>RemoteViews的内部机制</h1><p>RemoteViews的作用是在其他进程中显示并更新View的显示。为了更好的理解他的内部机制，我们来看一下他的主要功能。首先看一下构造方法，这里介绍一种最常用的构造方法<code>new RemoteViews(context.getPackageName(), R.layout.widget);</code>。它接受两个值，一个是应用包名，一个是待加载的布局文件。这里很好理解。<br>RemoteViews不支持所有的View类型<br>目前支持的类型如下</p>
<ul>
<li>Layout<br>FramLayout,LinearLayout,RelativeLayout,CridLayout</li>
<li>View<br>AnalogClock,Button,CHronometer,ImageButton,ImageView,ProgressBar,TestView,ViewFlipper，ListView，GridView，StackView，AdapterViewFlipper，ViewStub<br>上面描述的是RemoteViews所支持的所有View的类型，RemoteViews不支持他们的子类以及其他View类型。也就是说RemoteViews中不能使用除了上述列表意外的View也无法使用自定义View。比如我们在通知栏的RemoteViews中使用系统的EditText，那么通知栏消息将无法弹出并会报错。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">? W/AppWidgetHostView: updateAppWidget couldn&apos;t find any view, using error view</span><br><span class="line">    android.view.InflateException: Binary XML file line #14: Binary XML file line #14: Error inflating class android.widget.EditText</span><br><span class="line">    Caused by: android.view.InflateException: Binary XML file line #14: Error inflating class android.widget.EditText</span><br><span class="line">    Caused by: android.view.InflateException: Binary XML file line #14: Class not allowed to be inflated android.widget.EditText</span><br><span class="line">        at android.view.LayoutInflater.failNotAllowed(LayoutInflater.java:686)</span><br><span class="line">        at android.view.LayoutInflater.createView(LayoutInflater.java:612)</span><br><span class="line">        at com.android.internal.policy.PhoneLayoutInflater.onCreateView(PhoneLayoutInflater.java:58)</span><br><span class="line">        at android.view.LayoutInflater.onCreateView(LayoutInflater.java:720)</span><br><span class="line">        at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:788)</span><br><span class="line">        at android.view.LayoutInflater.createViewFromTag(LayoutInflater.java:730)</span><br><span class="line">        at android.view.LayoutInflater.rInflate(LayoutInflater.java:863)</span><br><span class="line">        at android.view.LayoutInflater.rInflateChildren(LayoutInflater.java:824)</span><br><span class="line">        at android.view.LayoutInflater.inflate(LayoutInflater.java:515)</span><br><span class="line">        at android.view.LayoutInflater.inflate(LayoutInflater.java:423)</span><br><span class="line">        at android.widget.RemoteViews.inflateView(RemoteViews.java:3278)</span><br><span class="line">        at android.widget.RemoteViews.apply(RemoteViews.java:3255)</span><br><span class="line">        at android.appwidget.AppWidgetHostView.applyRemoteViews(AppWidgetHostView.java:451)</span><br><span class="line">        at android.appwidget.AppWidgetHostView.updateAppWidget(AppWidgetHostView.java:380)</span><br><span class="line">        at com.android.launcher3.LauncherAppWidgetHostView.updateAppWidget(SourceFile:19)</span><br><span class="line">        at android.appwidget.AppWidgetHost.updateAppWidgetView(AppWidgetHost.java:404)</span><br><span class="line">        at android.appwidget.AppWidgetHost.startListening(AppWidgetHost.java:202)</span><br><span class="line">        at com.android.launcher3.LauncherAppWidgetHost.startListening(SourceFile:9)</span><br><span class="line">        at com.android.launcher3.Launcher.onStart(SourceFile:577)</span><br><span class="line">        at android.app.Instrumentation.callActivityOnStart(Instrumentation.java:1333)</span><br><span class="line">        at android.app.Activity.performStart(Activity.java:6992)</span><br><span class="line">        at android.app.Activity.performRestart(Activity.java:7066)</span><br><span class="line">        at android.app.Activity.performResume(Activity.java:7071)</span><br><span class="line">        at android.app.ActivityThread.performResumeActivity(ActivityThread.java:3620)</span><br><span class="line">        at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:3685)</span><br><span class="line">        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1643)</span><br><span class="line">        at android.os.Handler.dispatchMessage(Handler.java:105)</span><br><span class="line">        at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">        at android.app.ActivityThread.main(ActivityThread.java:6541)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">        at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:240)</span><br><span class="line">        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>意思是无法找到这个控件，无法inflate。然后就无法显示控件</p>
<p>RemoteViews没有提供findViewById的方法，因此我们无法直接访问里面的View的数据。而必须通过RemoteViews所提供的一系列set方法来完成。当然这个是因为RemoteViews在其他进程中，所以无法直接findViewById。这里列举一些常用的方法</p>
<table>
<thead>
<tr>
<th style="text-align:center">方法名</th>
<th style="text-align:center">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">setTextViewText(int viewId, CharSequence text)</td>
<td style="text-align:center">设置文字内容</td>
</tr>
<tr>
<td style="text-align:center">setTextViewTextSize(int viewId, int units, float size)</td>
<td style="text-align:center">设置文字大小</td>
</tr>
<tr>
<td style="text-align:center">setViewVisibility(int viewId, int visibility)</td>
<td style="text-align:center">设置是否可见</td>
</tr>
<tr>
<td style="text-align:center">setImageViewBitmap(int viewId, Bitmap bitmap)</td>
<td style="text-align:center">设置图片</td>
</tr>
<tr>
<td style="text-align:center">setEmptyView(int viewId, int emptyViewId)</td>
<td style="text-align:center">设置空图片</td>
</tr>
</tbody>
</table>
<p>从表可以看出，原本可以直接调用View的方法，但是现在必须通过RemoteViews的set方法才能完成，而且冲方法声明上来看，很像是通过反射来完成的<br>下面来描述一下RemoteViews的内部机制，由于RemoteViews主要用于通知栏和桌面小部件中，这里就通过他们来分析一下RemoteViews的工作流程。我们知道，通知栏和桌面小插件部分是分别由NotifacationManager和AppWidgetmanager来管理的，而NotificationManager和AppWidgetManager通过Binder分别和SystemServer进程中的NotificationMangaerService以及AppWidgetService进行通信。由此可见，通知栏和左面小部件中的布局是在NotificationManagerServcice和AppWidgetService中加载的，他们运行在系统的SystemServer中，这就和我们构成了跨进程通讯的场景。</p>
<p>首先RemoteViews会通过Binder传递到SystemServer进程，这是因为RemoteViews实现了Parcelable接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class RemoteViews implements Parcelable, Filter &#123;...&#125;</span><br></pre></td></tr></table></figure></p>
<p>因此他可以跨进程传输，系统会根据RemoteViews中的包名的该信息去得到该应用的资源。然后会通过layoutInflater去加载RemoteViews中的布局文件。在SystemServer进程中加载后的布局文件是一个普通的View，只不过相对于我们的进程而言是一个RemoteViews，但是要记住，RemoteViews不是一个View，他是一个数据结构，实现了Parcelable接口，用来跨进程通讯的。接着系统会对View执行一系列更新界面的任务。这些人无语是我们通过set方法来提交的，但是set方法对于View的更新不是立即就做的，在RemoteViews内部会记录所有的更新操作，直到RemoteViews被加载以后才会执行，这样RemoteViews就可以在SYstemServer进程中显示了。这就是我们所看到了通知栏或者小部件中的内容。当我们需要跟新UI的时候，我们需要调用一系列的set方法，并通过NotificationManager和AppWidgetManager来提交跟新任务。具体的跟新操作也是在SystemServer进程中完成的。<br>从理论上来说。系统完全可以通过Binder去支持所有的View和View的操作，但是这样的代价太大了，因为View的方法太多了，另外就是大量的IPC操作会影响效率。为了解决这个问题，系统并没有通过BInder去直接支持View的跨进程通讯，而是提供了一个Action的概念，Action代表一个View的操作，Action同样实现了Parcelable接口。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private abstract static class Action implements Parcelable &#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p>系统首先将View对象中的具体操作分装到Action对象中，并将这些对象跨进程传输到远程进程。接着在远程进程中执行Action对象的具体操作。在我们的应用中每调用一次set方法，RemoteViews中就会添加一个对应的Action对象，当我们通过NotificationManager和AppWidgetManager，来提交我们的更新时，这些Action对象就会传输到远程进程中并在远程进程中依次执行。</p>
<p><img src="图像1525593096.png" alt="Alt text" title="RemoteViews内部机制"></p>
<p>远程进程的RemoteViews的apply方法进行View的更新操作，具体的View更新操作是由Action对象内部的apply来完成的。上述方法的好处显而易见，首先不需要定义大量的Binder接口，其次通过在远程进程中批量执行RemoteViews的修改操作从而避免大量的IPC操作，这就提高了程序的性能，由此可见，Android系统在这方面的设计很巧妙。<br>上面从理论分析了RemoteViews的机制,现在从源码的角度来分析一下RemoteViews的，先看一下一系列的set方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void setImageViewBitmap(int viewId, Bitmap bitmap) &#123;</span><br><span class="line">     setBitmap(viewId, &quot;setImageBitmap&quot;, bitmap);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到set方法最终调用了一个setBitmap方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void setBitmap(int viewId, String methodName, Bitmap value) &#123;</span><br><span class="line">    addAction(new BitmapReflectionAction(viewId, methodName, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里就出现了action<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void addAction(Action a) &#123;</span><br><span class="line">    if (hasLandscapeAndPortraitLayouts()) &#123;</span><br><span class="line">        throw new RuntimeException(&quot;RemoteViews specifying separate landscape and portrait&quot; +</span><br><span class="line">                &quot; layouts cannot be modified. Instead, fully configure the landscape and&quot; +</span><br><span class="line">                &quot; portrait layouts individually before constructing the combined layout.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (mActions == null) &#123;</span><br><span class="line">        mActions = new ArrayList&lt;Action&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    mActions.add(a);</span><br><span class="line"></span><br><span class="line">    // update the memory usage stats</span><br><span class="line">    a.updateMemoryUsageEstimate(mMemoryUsageCounter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码可以看到，RemoteViews内部有一个Action集合，外界每调用一次set方法，RemoteViews就会为其创建一个Action对象并加入到这个集合中。需要注意的是这里仅仅是将action对象保存了起来，并未对View进行实际操作。这一点在上面的理论分析中已经提到过了。一个set方法的源码已经分析完毕了，但是我们还是不知道什么时候会将这个集合传递出去。这里要看一下RemoteViews的apply方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public View apply(Context context, ViewGroup parent, OnClickHandler handler) &#123;</span><br><span class="line">        RemoteViews rvToApply = getRemoteViewsToApply(context);</span><br><span class="line"></span><br><span class="line">        View result = inflateView(context, rvToApply, parent);</span><br><span class="line">        loadTransitionOverride(context, handler);</span><br><span class="line"></span><br><span class="line">        rvToApply.performApply(result, parent, handler);</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面的代码可以看出，首先会通过LayoutLnflater去加载RemoteViews中的布局文件，RemoteViews中布局文件可以通过getLayoutId这个方法获得，加载完布局文件后会通过performApply去执行一些更新操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void performApply(View v, ViewGroup parent, OnClickHandler handler) &#123;</span><br><span class="line">      if (mActions != null) &#123;</span><br><span class="line">          handler = handler == null ? DEFAULT_ON_CLICK_HANDLER : handler;</span><br><span class="line">          final int count = mActions.size();</span><br><span class="line">          for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">              Action a = mActions.get(i);</span><br><span class="line">              a.apply(v, parent, handler);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到他的作用是遍历action的集合并执行action对象。每一次的set操作对应一个action对象，所以说这里才是真正操作View的地方。</p>
<p>RemoteViews在通知栏和桌面小部件的工作过程和上面描述的过程是一致的，当我们调用RemoteViews的set方法时，并不会立即更新界面，而是必须要通过NotificationManager的notify方法以及AppWidgetManager的updateAppWidget才能更新他们的界面。实际上在AppWidgetManger的updateAppWidget的内部实现的，apply和reApply的区别在于：apply会加载布局并更新界面，reApply只会更新界面。通知栏和桌面小插件在初始化界面会调用apply方法，而在后续的更新界面则会调用reApply方法。这里看看一下AppWidgetHostView的updateAppWidget方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public void updateAppWidget(RemoteViews remoteViews) &#123;</span><br><span class="line">    applyRemoteViews(remoteViews, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected void applyRemoteViews(RemoteViews remoteViews, boolean useAsyncIfPossible) &#123;</span><br><span class="line">       if (LOGD) Log.d(TAG, &quot;updateAppWidget called mOld=&quot; + mOld);</span><br><span class="line"></span><br><span class="line">       boolean recycled = false;</span><br><span class="line">       View content = null;</span><br><span class="line">       Exception exception = null;</span><br><span class="line"></span><br><span class="line">       // Capture the old view into a bitmap so we can do the crossfade.</span><br><span class="line">       if (CROSSFADE) &#123;</span><br><span class="line">           if (mFadeStartTime &lt; 0) &#123;</span><br><span class="line">               if (mView != null) &#123;</span><br><span class="line">                   final int width = mView.getWidth();</span><br><span class="line">                   final int height = mView.getHeight();</span><br><span class="line">                   try &#123;</span><br><span class="line">                       mOld = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">                   &#125; catch (OutOfMemoryError e) &#123;</span><br><span class="line">                       // we just won&apos;t do the fade</span><br><span class="line">                       mOld = null;</span><br><span class="line">                   &#125;</span><br><span class="line">                   if (mOld != null) &#123;</span><br><span class="line">                       //mView.drawIntoBitmap(mOld);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (mLastExecutionSignal != null) &#123;</span><br><span class="line">           mLastExecutionSignal.cancel();</span><br><span class="line">           mLastExecutionSignal = null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (remoteViews == null) &#123;</span><br><span class="line">           if (mViewMode == VIEW_MODE_DEFAULT) &#123;</span><br><span class="line">               // We&apos;ve already done this -- nothing to do.</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line">           content = getDefaultView();</span><br><span class="line">           mLayoutId = -1;</span><br><span class="line">           mViewMode = VIEW_MODE_DEFAULT;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           if (mAsyncExecutor != null &amp;&amp; useAsyncIfPossible) &#123;</span><br><span class="line">               inflateAsync(remoteViews);</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line">           // Prepare a local reference to the remote Context so we&apos;re ready to</span><br><span class="line">           // inflate any requested LayoutParams.</span><br><span class="line">           mRemoteContext = getRemoteContext();</span><br><span class="line">           int layoutId = remoteViews.getLayoutId();</span><br><span class="line"></span><br><span class="line">           // If our stale view has been prepared to match active, and the new</span><br><span class="line">           // layout matches, try recycling it</span><br><span class="line">           if (content == null &amp;&amp; layoutId == mLayoutId) &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                   remoteViews.reapply(mContext, mView, mOnClickHandler);</span><br><span class="line">                   content = mView;</span><br><span class="line">                   recycled = true;</span><br><span class="line">                   if (LOGD) Log.d(TAG, &quot;was able to recycle existing layout&quot;);</span><br><span class="line">               &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                   exception = e;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           // Try normal RemoteView inflation</span><br><span class="line">           if (content == null) &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                 //在这里===========================</span><br><span class="line">                   content = remoteViews.apply(mContext, this, mOnClickHandler);</span><br><span class="line">                   if (LOGD) Log.d(TAG, &quot;had to inflate new layout&quot;);</span><br><span class="line">               &#125; catch (RuntimeException e) &#123;</span><br><span class="line">                   exception = e;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           mLayoutId = layoutId;</span><br><span class="line">           mViewMode = VIEW_MODE_CONTENT;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       applyContent(content, recycled, exception);</span><br><span class="line">       updateContentDescription(mInfo);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到有一行<code>content = remoteViews.apply(mContext, this, mOnClickHandler);</code></p>
<p>现在了解了具体的做法，现在来看一下action他儿子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line">private final class ReflectionAction extends Action &#123;</span><br><span class="line">        static final int TAG = 2;</span><br><span class="line"></span><br><span class="line">        static final int BOOLEAN = 1;</span><br><span class="line">        static final int BYTE = 2;</span><br><span class="line">        static final int SHORT = 3;</span><br><span class="line">        static final int INT = 4;</span><br><span class="line">        static final int LONG = 5;</span><br><span class="line">        static final int FLOAT = 6;</span><br><span class="line">        static final int DOUBLE = 7;</span><br><span class="line">        static final int CHAR = 8;</span><br><span class="line">        static final int STRING = 9;</span><br><span class="line">        static final int CHAR_SEQUENCE = 10;</span><br><span class="line">        static final int URI = 11;</span><br><span class="line">        // BITMAP actions are never stored in the list of actions. They are only used locally</span><br><span class="line">        // to implement BitmapReflectionAction, which eliminates duplicates using BitmapCache.</span><br><span class="line">        static final int BITMAP = 12;</span><br><span class="line">        static final int BUNDLE = 13;</span><br><span class="line">        static final int INTENT = 14;</span><br><span class="line">        static final int COLOR_STATE_LIST = 15;</span><br><span class="line">        static final int ICON = 16;</span><br><span class="line"></span><br><span class="line">        String methodName;</span><br><span class="line">        int type;</span><br><span class="line">        Object value;</span><br><span class="line"></span><br><span class="line">        ReflectionAction(int viewId, String methodName, int type, Object value) &#123;</span><br><span class="line">            this.viewId = viewId;</span><br><span class="line">            this.methodName = methodName;</span><br><span class="line">            this.type = type;</span><br><span class="line">            this.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReflectionAction(Parcel in) &#123;</span><br><span class="line">            this.viewId = in.readInt();</span><br><span class="line">            this.methodName = in.readString();</span><br><span class="line">            this.type = in.readInt();</span><br><span class="line">            //noinspection ConstantIfStatement</span><br><span class="line">            if (false) &#123;</span><br><span class="line">                Log.d(LOG_TAG, &quot;read viewId=0x&quot; + Integer.toHexString(this.viewId)</span><br><span class="line">                        + &quot; methodName=&quot; + this.methodName + &quot; type=&quot; + this.type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // For some values that may have been null, we first check a flag to see if they were</span><br><span class="line">            // written to the parcel.</span><br><span class="line">            switch (this.type) &#123;</span><br><span class="line">                case BOOLEAN:</span><br><span class="line">                    this.value = in.readInt() != 0;</span><br><span class="line">                    break;</span><br><span class="line">                case BYTE:</span><br><span class="line">                    this.value = in.readByte();</span><br><span class="line">                    break;</span><br><span class="line">                case SHORT:</span><br><span class="line">                    this.value = (short)in.readInt();</span><br><span class="line">                    break;</span><br><span class="line">                case INT:</span><br><span class="line">                    this.value = in.readInt();</span><br><span class="line">                    break;</span><br><span class="line">                case LONG:</span><br><span class="line">                    this.value = in.readLong();</span><br><span class="line">                    break;</span><br><span class="line">                case FLOAT:</span><br><span class="line">                    this.value = in.readFloat();</span><br><span class="line">                    break;</span><br><span class="line">                case DOUBLE:</span><br><span class="line">                    this.value = in.readDouble();</span><br><span class="line">                    break;</span><br><span class="line">                case CHAR:</span><br><span class="line">                    this.value = (char)in.readInt();</span><br><span class="line">                    break;</span><br><span class="line">                case STRING:</span><br><span class="line">                    this.value = in.readString();</span><br><span class="line">                    break;</span><br><span class="line">                case CHAR_SEQUENCE:</span><br><span class="line">                    this.value = TextUtils.CHAR_SEQUENCE_CREATOR.createFromParcel(in);</span><br><span class="line">                    break;</span><br><span class="line">                case URI:</span><br><span class="line">                    if (in.readInt() != 0) &#123;</span><br><span class="line">                        this.value = Uri.CREATOR.createFromParcel(in);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case BITMAP:</span><br><span class="line">                    if (in.readInt() != 0) &#123;</span><br><span class="line">                        this.value = Bitmap.CREATOR.createFromParcel(in);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case BUNDLE:</span><br><span class="line">                    this.value = in.readBundle();</span><br><span class="line">                    break;</span><br><span class="line">                case INTENT:</span><br><span class="line">                    if (in.readInt() != 0) &#123;</span><br><span class="line">                        this.value = Intent.CREATOR.createFromParcel(in);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case COLOR_STATE_LIST:</span><br><span class="line">                    if (in.readInt() != 0) &#123;</span><br><span class="line">                        this.value = ColorStateList.CREATOR.createFromParcel(in);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case ICON:</span><br><span class="line">                    if (in.readInt() != 0) &#123;</span><br><span class="line">                        this.value = Icon.CREATOR.createFromParcel(in);</span><br><span class="line">                    &#125;</span><br><span class="line">                default:</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public void writeToParcel(Parcel out, int flags) &#123;</span><br><span class="line">            out.writeInt(TAG);</span><br><span class="line">            out.writeInt(this.viewId);</span><br><span class="line">            out.writeString(this.methodName);</span><br><span class="line">            out.writeInt(this.type);</span><br><span class="line">            //noinspection ConstantIfStatement</span><br><span class="line">            if (false) &#123;</span><br><span class="line">                Log.d(LOG_TAG, &quot;write viewId=0x&quot; + Integer.toHexString(this.viewId)</span><br><span class="line">                        + &quot; methodName=&quot; + this.methodName + &quot; type=&quot; + this.type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // For some values which are null, we record an integer flag to indicate whether</span><br><span class="line">            // we have written a valid value to the parcel.</span><br><span class="line">            switch (this.type) &#123;</span><br><span class="line">                case BOOLEAN:</span><br><span class="line">                    out.writeInt((Boolean) this.value ? 1 : 0);</span><br><span class="line">                    break;</span><br><span class="line">                case BYTE:</span><br><span class="line">                    out.writeByte((Byte) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case SHORT:</span><br><span class="line">                    out.writeInt((Short) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case INT:</span><br><span class="line">                    out.writeInt((Integer) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case LONG:</span><br><span class="line">                    out.writeLong((Long) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case FLOAT:</span><br><span class="line">                    out.writeFloat((Float) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case DOUBLE:</span><br><span class="line">                    out.writeDouble((Double) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case CHAR:</span><br><span class="line">                    out.writeInt((int)((Character)this.value).charValue());</span><br><span class="line">                    break;</span><br><span class="line">                case STRING:</span><br><span class="line">                    out.writeString((String)this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case CHAR_SEQUENCE:</span><br><span class="line">                    TextUtils.writeToParcel((CharSequence)this.value, out, flags);</span><br><span class="line">                    break;</span><br><span class="line">                case URI:</span><br><span class="line">                    out.writeInt(this.value != null ? 1 : 0);</span><br><span class="line">                    if (this.value != null) &#123;</span><br><span class="line">                        ((Uri)this.value).writeToParcel(out, flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case BITMAP:</span><br><span class="line">                    out.writeInt(this.value != null ? 1 : 0);</span><br><span class="line">                    if (this.value != null) &#123;</span><br><span class="line">                        ((Bitmap)this.value).writeToParcel(out, flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case BUNDLE:</span><br><span class="line">                    out.writeBundle((Bundle) this.value);</span><br><span class="line">                    break;</span><br><span class="line">                case INTENT:</span><br><span class="line">                    out.writeInt(this.value != null ? 1 : 0);</span><br><span class="line">                    if (this.value != null) &#123;</span><br><span class="line">                        ((Intent)this.value).writeToParcel(out, flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case COLOR_STATE_LIST:</span><br><span class="line">                    out.writeInt(this.value != null ? 1 : 0);</span><br><span class="line">                    if (this.value != null) &#123;</span><br><span class="line">                        ((ColorStateList)this.value).writeToParcel(out, flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case ICON:</span><br><span class="line">                    out.writeInt(this.value != null ? 1 : 0);</span><br><span class="line">                    if (this.value != null) &#123;</span><br><span class="line">                        ((Icon)this.value).writeToParcel(out, flags);</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private Class&lt;?&gt; getParameterType() &#123;</span><br><span class="line">            switch (this.type) &#123;</span><br><span class="line">                case BOOLEAN:</span><br><span class="line">                    return boolean.class;</span><br><span class="line">                case BYTE:</span><br><span class="line">                    return byte.class;</span><br><span class="line">                case SHORT:</span><br><span class="line">                    return short.class;</span><br><span class="line">                case INT:</span><br><span class="line">                    return int.class;</span><br><span class="line">                case LONG:</span><br><span class="line">                    return long.class;</span><br><span class="line">                case FLOAT:</span><br><span class="line">                    return float.class;</span><br><span class="line">                case DOUBLE:</span><br><span class="line">                    return double.class;</span><br><span class="line">                case CHAR:</span><br><span class="line">                    return char.class;</span><br><span class="line">                case STRING:</span><br><span class="line">                    return String.class;</span><br><span class="line">                case CHAR_SEQUENCE:</span><br><span class="line">                    return CharSequence.class;</span><br><span class="line">                case URI:</span><br><span class="line">                    return Uri.class;</span><br><span class="line">                case BITMAP:</span><br><span class="line">                    return Bitmap.class;</span><br><span class="line">                case BUNDLE:</span><br><span class="line">                    return Bundle.class;</span><br><span class="line">                case INTENT:</span><br><span class="line">                    return Intent.class;</span><br><span class="line">                case COLOR_STATE_LIST:</span><br><span class="line">                    return ColorStateList.class;</span><br><span class="line">                case ICON:</span><br><span class="line">                    return Icon.class;</span><br><span class="line">                default:</span><br><span class="line">                    return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void apply(View root, ViewGroup rootParent, OnClickHandler handler) &#123;</span><br><span class="line">            final View view = root.findViewById(viewId);</span><br><span class="line">            if (view == null) return;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; param = getParameterType();</span><br><span class="line">            if (param == null) &#123;</span><br><span class="line">                throw new ActionException(&quot;bad type: &quot; + this.type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                getMethod(view, this.methodName, param).invoke(view, wrapArg(this.value));</span><br><span class="line">            &#125; catch (ActionException e) &#123;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                throw new ActionException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public Action initActionAsync(ViewTree root, ViewGroup rootParent, OnClickHandler handler) &#123;</span><br><span class="line">            final View view = root.findViewById(viewId);</span><br><span class="line">            if (view == null) return ACTION_NOOP;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; param = getParameterType();</span><br><span class="line">            if (param == null) &#123;</span><br><span class="line">                throw new ActionException(&quot;bad type: &quot; + this.type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                Method method = getMethod(view, this.methodName, param);</span><br><span class="line">                Method asyncMethod = getAsyncMethod(method);</span><br><span class="line"></span><br><span class="line">                if (asyncMethod != null) &#123;</span><br><span class="line">                    Runnable endAction = (Runnable) asyncMethod.invoke(view, wrapArg(this.value));</span><br><span class="line">                    if (endAction == null) &#123;</span><br><span class="line">                        return ACTION_NOOP;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        // Special case view stub</span><br><span class="line">                        if (endAction instanceof ViewStub.ViewReplaceRunnable) &#123;</span><br><span class="line">                            root.createTree();</span><br><span class="line">                            // Replace child tree</span><br><span class="line">                            root.findViewTreeById(viewId).replaceView(</span><br><span class="line">                                    ((ViewStub.ViewReplaceRunnable) endAction).view);</span><br><span class="line">                        &#125;</span><br><span class="line">                        return new RunnableAction(endAction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (ActionException e) &#123;</span><br><span class="line">                throw e;</span><br><span class="line">            &#125; catch (Exception ex) &#123;</span><br><span class="line">                throw new ActionException(ex);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public int mergeBehavior() &#123;</span><br><span class="line">            // smoothScrollBy is cumulative, everything else overwites.</span><br><span class="line">            if (methodName.equals(&quot;smoothScrollBy&quot;)) &#123;</span><br><span class="line">                return MERGE_APPEND;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return MERGE_REPLACE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String getActionName() &#123;</span><br><span class="line">            // Each type of reflection action corresponds to a setter, so each should be seen as</span><br><span class="line">            // unique from the standpoint of merging.</span><br><span class="line">            return &quot;ReflectionAction&quot; + this.methodName + this.type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean prefersAsyncApply() &#123;</span><br><span class="line">            return this.type == URI || this.type == ICON;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，他是一个反射动作，通过他对使用反射的方式<code>getMethod(view, this.methodName, param).invoke(view, wrapArg(this.value));</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">private class TextViewSizeAction extends Action &#123;</span><br><span class="line">    public TextViewSizeAction(int viewId, int units, float size) &#123;</span><br><span class="line">        this.viewId = viewId;</span><br><span class="line">        this.units = units;</span><br><span class="line">        this.size = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public TextViewSizeAction(Parcel parcel) &#123;</span><br><span class="line">        viewId = parcel.readInt();</span><br><span class="line">        units = parcel.readInt();</span><br><span class="line">        size  = parcel.readFloat();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void writeToParcel(Parcel dest, int flags) &#123;</span><br><span class="line">        dest.writeInt(TAG);</span><br><span class="line">        dest.writeInt(viewId);</span><br><span class="line">        dest.writeInt(units);</span><br><span class="line">        dest.writeFloat(size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void apply(View root, ViewGroup rootParent, OnClickHandler handler) &#123;</span><br><span class="line">        final TextView target = root.findViewById(viewId);</span><br><span class="line">        if (target == null) return;</span><br><span class="line">        target.setTextSize(units, size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getActionName() &#123;</span><br><span class="line">        return &quot;TextViewSizeAction&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int units;</span><br><span class="line">    float size;</span><br><span class="line"></span><br><span class="line">    public final static int TAG = 13;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个比较简单，就不分析了。<br>关于单击事件，RemoteVies中只支持发起PendingIntent，不支持onClickListener模式。另外我们需要注意setOnClickPendingIntent，setPengdingIntentTemplate，setOnClickFillIInIntent之间的联系。<br>首先：setOnClickPendingIntent用于给普通的View设置单击事件，但是不能给集合设置单击事件（ListView和StackView）中的View设置单击事件；其次要给ListView和stackView中的Item设置单击事件，必须将SetPendingIntentTemplate和setOnClickFillInIntent组合才可以。</p>
<h1 id="RemoteViews的意义"><a href="#RemoteViews的意义" class="headerlink" title="RemoteViews的意义"></a>RemoteViews的意义</h1><p>在之前的章节，已经分析了RemoteViews的内部机制，了解RemoteViews的内部机制可以让我妈更加清晰的了解通知栏和桌面小工具的实现原理。但是本章对RemoteViews的探索并没有终止。在本章节中我们将打造一个模拟通知栏并实现跨进程的UI更新操作。</p>
<p>首先是两个Activityy分别运行在不同的进程中，一个名字叫A，一个名字叫B，其中A扮演模拟通知栏的角色，B则可以不听的发送通知栏消息，当然这是模拟消息的信息。为了模拟通知栏效果，我们修改A的Progress属性，使其运行在单独的进程。这样A和B就构成了多进程通讯。我们在B中创建RemoteViews对象，然后通知A显示这个RemoteViews对象。如何通过通知A显示B中的remoteViews呢？我们可以像系统一样使用Binder来实现，但是为了简单期间就使用广播。B每发送一次通知，就会发送一个特定广播，然后A接受到这个特定广播，后开始显示B中定义的RemoteViews对象，这个过程和系统的通知栏消息的显示过程几乎一致，或者说这里就是负值了通知栏的显示过程而已。<br>首先看一下B的实现。B只要构造RemoteViews并将其传递给A就可以了。这一过程通知栏采用Binder实现，这里采用广播来实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class AActivity extends Activity &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static final String TAG = &quot;MainActivity&quot;;</span><br><span class="line">    private LinearLayout mRemoteViewsContent;</span><br><span class="line">    private BroadcastReceiver mRemoteViewReceiver = new BroadcastReceiver() &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">          RemoteViews remoteViews = intent.getParcelableExtra(&quot;xxx,xxx&quot;);</span><br><span class="line">                 if (remoteViews != null) &#123;</span><br><span class="line">                     updateUI(remoteViews);</span><br><span class="line">                 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        initView();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void initView() &#123;</span><br><span class="line">        mRemoteViewsContent=findViewById(R.id.test);</span><br><span class="line">        IntentFilter filter=new IntentFilter(&quot;xxx,xxx&quot;);</span><br><span class="line">        registerReceiver(mRemoteViewReceiver,filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private void  updateUI(RemoteViews remoteViews)&#123;</span><br><span class="line">        View view=remoteViews.apply(this,mRemoteViewsContent);</span><br><span class="line">        mRemoteViewsContent.addView(view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onDestroy() &#123;</span><br><span class="line">        unregisterReceiver(mRemoteViewReceiver);</span><br><span class="line">        super.onDestroy();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class BActivity extends Activity &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(@Nullable Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        RemoteViews remoteViews = new RemoteViews(getPackageName(), R.layout.b_activity);</span><br><span class="line"></span><br><span class="line">        remoteViews.setTextViewText(R.id.msg, &quot;msg from process :&quot;);</span><br><span class="line">        PendingIntent pendingIntent = PendingIntent.getActivity(this, 0, new Intent(this, DemoActivity_1.class), PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">        PendingIntent openActivity2 = PendingIntent.getActivity(this, 0, new Intent(this, DemoActivity_2.class), PendingIntent.FLAG_UPDATE_CURRENT);</span><br><span class="line">        remoteViews.setOnClickPendingIntent(R.id.item_holder, pendingIntent);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Intent intent = new Intent(&quot;xxx.xxx&quot;);</span><br><span class="line">        intent.putExtra(&quot;xxx.xxx&quot;, remoteViews);</span><br><span class="line">        sendBroadcast(intent);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是一个数据的传递。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/进阶/" rel="tag"># 进阶</a>
          
            <a href="/tags/Android开发艺术探索/" rel="tag"># Android开发艺术探索</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/android/Android开发艺术探索_第四章 View的工作原理/" rel="next" title="Android开发艺术探索 第四章 View的工作原理">
                <i class="fa fa-chevron-left"></i> Android开发艺术探索 第四章 View的工作原理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/android/Android开发艺术探索_第六章 Android的Drawable/" rel="prev" title="Android开发艺术探索 第六章 Android的Drawable">
                Android开发艺术探索 第六章 Android的Drawable <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Groot</p>
              <p class="site-description motion-element" itemprop="description">尽信书则不如无书</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#RemoteViews的应用"><span class="nav-number">1.</span> <span class="nav-text">RemoteViews的应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RemoteView在通知栏的应用"><span class="nav-number">1.1.</span> <span class="nav-text">RemoteView在通知栏的应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RemoteViews在桌面小部件的应用"><span class="nav-number">1.2.</span> <span class="nav-text">RemoteViews在桌面小部件的应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PendingIntent的概述"><span class="nav-number">1.3.</span> <span class="nav-text">PendingIntent的概述</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RemoteViews的内部机制"><span class="nav-number">2.</span> <span class="nav-text">RemoteViews的内部机制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RemoteViews的意义"><span class="nav-number">3.</span> <span class="nav-text">RemoteViews的意义</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Groot</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
