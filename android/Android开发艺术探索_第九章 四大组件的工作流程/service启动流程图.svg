<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="989px" preserveAspectRatio="none" style="width:1252px;height:989px;" version="1.1" viewBox="0 0 1252 989" width="1252px" zoomAndPan="magnify"><defs><filter height="300%" id="f18rhkzsqfoydu" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="35" x2="35" y1="89.1201" y2="899.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="234" x2="234" y1="89.1201" y2="899.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="409" x2="409" y1="89.1201" y2="899.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="560" x2="560" y1="89.1201" y2="899.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="708" x2="708" y1="89.1201" y2="899.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="933" x2="933" y1="89.1201" y2="899.7344"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1121.5" x2="1121.5" y1="89.1201" y2="899.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="8" y="86.0439">Context</text><ellipse cx="35" cy="13" fill="#FF0000" filter="url(#f18rhkzsqfoydu)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M35,21 L35,48 M22,29 L48,29 M35,48 L22,63 M35,48 L48,63 " fill="none" filter="url(#f18rhkzsqfoydu)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="8" y="914.7783">Context</text><ellipse cx="35" cy="927.8545" fill="#FF0000" filter="url(#f18rhkzsqfoydu)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M35,935.8545 L35,962.8545 M22,943.8545 L48,943.8545 M35,962.8545 L22,977.8545 M35,962.8545 L48,977.8545 " fill="none" filter="url(#f18rhkzsqfoydu)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="190" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="197" y="74.0439">contextImpl</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="190" y="898.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="197" y="921.7783">contextImpl</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="350" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="357" y="74.0439">ActivityManager</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="350" y="898.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="357" y="921.7783">ActivityManager</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="478" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="485" y="74.0439">ActivityManagerService</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="478" y="898.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="485" y="921.7783">ActivityManagerService</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="653" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="660" y="74.0439">ActiveServices</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="653" y="898.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="660" y="921.7783">ActiveServices</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="879" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="886" y="74.0439">ActivityThread</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="879" y="898.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="886" y="921.7783">ActivityThread</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="1088.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1095.5" y="74.0439">Handler</text><rect fill="#FEFECE" filter="url(#f18rhkzsqfoydu)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="1088.5" y="898.7344"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1095.5" y="921.7783">Handler</text><polygon fill="#A80036" points="222,118.1201,232,122.1201,222,126.1201,226,122.1201" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="35" x2="228" y1="122.1201" y2="122.1201"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="42" y="118.0181">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="75" y="118.0181">startService()启动service</text><path d="M101,135.8745 L101,198.8745 L362,198.8745 L362,145.8745 L352,135.8745 L101,135.8745 " fill="#00FFFF" filter="url(#f18rhkzsqfoydu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M352,135.8745 L352,145.8745 L362,145.8745 L352,135.8745 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="107" y="155.7725">这个是contextImpl是context的具体实现，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="107" y="173.5269">在activity中startService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="107" y="191.2813">其实是调用contextImpl的startService()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="234" x2="276" y1="231.8921" y2="231.8921"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="276" x2="276" y1="231.8921" y2="244.8921"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="235" x2="276" y1="244.8921" y2="244.8921"/><polygon fill="#A80036" points="245,240.8921,235,244.8921,245,248.8921,241,244.8921" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="241" y="227.0356">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="274" y="227.0356">startServiceCommon()</text><polygon fill="#A80036" points="397,271.8921,407,275.8921,397,279.8921,401,275.8921" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="234" x2="403" y1="275.8921" y2="275.8921"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="241" y="271.79">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="278" y="271.79"/><polygon fill="#A80036" points="548.5,303.6465,558.5,307.6465,548.5,311.6465,552.5,307.6465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="409" x2="554.5" y1="307.6465" y2="307.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="416" y="303.5444">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="449" y="303.5444">getService</text><polygon fill="#A80036" points="696,335.4009,706,339.4009,696,343.4009,700,339.4009" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="560.5" x2="702" y1="339.4009" y2="339.4009"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="567.5" y="335.2988">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="600.5" y="335.2988">startService</text><path d="M540,353.1553 L540,398.1553 L872,398.1553 L872,363.1553 L862,353.1553 L540,353.1553 " fill="#00FFFF" filter="url(#f18rhkzsqfoydu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M862,353.1553 L862,363.1553 L872,363.1553 L862,353.1553 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="546" y="373.0532">ActiveServices是一个辅助AMS进行Service管理的类，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="546" y="390.8076">他包括Service的启动、绑定。停止等。</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="708" x2="750" y1="431.4185" y2="431.4185"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="750" x2="750" y1="431.4185" y2="444.4185"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="709" x2="750" y1="444.4185" y2="444.4185"/><polygon fill="#A80036" points="719,440.4185,709,444.4185,719,448.4185,715,444.4185" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="715" y="426.562">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="748" y="426.562">startServiceLocked()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="708" x2="750" y1="476.1729" y2="476.1729"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="750" x2="750" y1="476.1729" y2="489.1729"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="709" x2="750" y1="489.1729" y2="489.1729"/><polygon fill="#A80036" points="719,485.1729,709,489.1729,719,493.1729,715,489.1729" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="715" y="471.3164">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="748" y="471.3164">startServiceInnerLocked()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="708" x2="750" y1="520.9272" y2="520.9272"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="750" x2="750" y1="520.9272" y2="533.9272"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="709" x2="750" y1="533.9272" y2="533.9272"/><polygon fill="#A80036" points="719,529.9272,709,533.9272,719,537.9272,715,533.9272" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="715" y="516.0708">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="748" y="516.0708">bringUpServiceLocked()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="708" x2="750" y1="565.6816" y2="565.6816"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="750" x2="750" y1="565.6816" y2="578.6816"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="709" x2="750" y1="578.6816" y2="578.6816"/><polygon fill="#A80036" points="719,574.6816,709,578.6816,719,582.6816,715,578.6816" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="715" y="560.8252">[009]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="748" y="560.8252">realStartServiceLocked()</text><path d="M502,591.6816 L502,618.6816 L910,618.6816 L910,601.6816 L900,591.6816 L502,591.6816 " fill="#00FFFF" filter="url(#f18rhkzsqfoydu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,591.6816 L900,601.6816 L910,601.6816 L900,591.6816 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="508" y="611.5796">realStartServiceLocked才真正启动,进入realStartServiceLocked方法</text><polygon fill="#A80036" points="921,647.436,931,651.436,921,655.436,925,651.436" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="708" x2="927" y1="651.436" y2="651.436"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="715" y="647.334">[010]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="748" y="647.334">app.thread得到ActivityThread</text><polygon fill="#A80036" points="1110,679.1904,1120,683.1904,1110,687.1904,1114,683.1904" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="933" x2="1116" y1="683.1904" y2="683.1904"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="940" y="679.0884">[011]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="973" y="679.0884">scheduleCreateService</text><polygon fill="#A80036" points="944,710.9448,934,714.9448,944,718.9448,940,714.9448" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="938" x2="1121" y1="714.9448" y2="714.9448"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="950" y="710.8428">[012]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="983" y="710.8428">handleCreateService</text><path d="M622,728.6992 L622,880.6992 L1240,880.6992 L1240,738.6992 L1230,728.6992 L622,728.6992 " fill="#00FFFF" filter="url(#f18rhkzsqfoydu)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1230,728.6992 L1230,738.6992 L1240,738.6992 L1230,728.6992 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="628" y="748.5972">这个方法分为几个步骤：</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="628" y="766.3516">1. 首先通过类加载器来创建Service对象</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="533" x="628" y="784.106">2. 接着创建Application对象并调用其onCreate方法，当然Application创建过程只会只会有一次</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="597" x="628" y="801.8604">3. 接着创建ConTextImpl对象病通过Service的attach方法建立两者之间的联系，这个和Activity是类似的。</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="505" x="628" y="819.6147">4. 最后调用Service的onCreate方法并将Service对象存储到ActivityThread中的一个列表中</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="632" y="837.3691"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="422" x="628" y="855.1235">由于Service的onCreate方法已经被执行了，这意味着Service已经启动了，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="552" x="628" y="872.8779">除此之外，ActivityThread中还会通过handleServiceArgs方法调用Service的onStartCommand方法</text><!--
@startuml
actor Context #red
autonumber 1 1 "<b>[000]"
Context->contextImpl:startService()启动service
note over of contextImpl #aqua
这个是contextImpl是context的具体实现，
在activity中startService
其实是调用contextImpl的startService()
end note
contextImpl ->contextImpl : startServiceCommon()
contextImpl->ActivityManager:
ActivityManager->ActivityManagerService:getService
ActivityManagerService->ActiveServices:startService
note over of ActiveServices #aqua
ActiveServices是一个辅助AMS进行Service管理的类，
他包括Service的启动、绑定。停止等。
end note

ActiveServices->ActiveServices:startServiceLocked()
ActiveServices->ActiveServices:startServiceInnerLocked()
ActiveServices->ActiveServices:bringUpServiceLocked()
ActiveServices->ActiveServices:realStartServiceLocked()
note over of ActiveServices #aqua
realStartServiceLocked才真正启动,进入realStartServiceLocked方法
end note

ActiveServices->ActivityThread:app.thread得到ActivityThread
ActivityThread->Handler:scheduleCreateService
Handler->ActivityThread:handleCreateService
note over of ActivityThread #aqua
这个方法分为几个步骤：
1. 首先通过类加载器来创建Service对象
2. 接着创建Application对象并调用其onCreate方法，当然Application创建过程只会只会有一次
3. 接着创建ConTextImpl对象病通过Service的attach方法建立两者之间的联系，这个和Activity是类似的。
4. 最后调用Service的onCreate方法并将Service对象存储到ActivityThread中的一个列表中

由于Service的onCreate方法已经被执行了，这意味着Service已经启动了，
除此之外，ActivityThread中还会通过handleServiceArgs方法调用Service的onStartCommand方法
end note

autonumber stop
@enduml

PlantUML version 1.2018.01(Mon Jan 29 02:08:22 GMT+08:00 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1024-b02
Operating System: Windows 10
OS Version: 10.0
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>