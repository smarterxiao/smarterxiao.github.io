<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1320px" preserveAspectRatio="none" style="width:1675px;height:1320px;" version="1.1" viewBox="0 0 1675 1320" width="1675px" zoomAndPan="magnify"><defs><filter height="300%" id="fghnl0vzlw4rj" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="35" x2="35" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="232" x2="232" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="397" x2="397" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="575.5" x2="575.5" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="745" x2="745" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="926.5" x2="926.5" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1074.5" x2="1074.5" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1324.5" x2="1324.5" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1487" x2="1487" y1="89.1201" y2="1230.0327"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1599" x2="1599" y1="89.1201" y2="1230.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="8" y="86.0439">Context</text><ellipse cx="35" cy="13" fill="#FF0000" filter="url(#fghnl0vzlw4rj)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M35,21 L35,48 M22,29 L48,29 M35,48 L22,63 M35,48 L48,63 " fill="none" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="8" y="1245.0767">Context</text><ellipse cx="35" cy="1258.1528" fill="#FF0000" filter="url(#fghnl0vzlw4rj)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M35,1266.1528 L35,1293.1528 M22,1274.1528 L48,1274.1528 M35,1293.1528 L22,1308.1528 M35,1293.1528 L48,1308.1528 " fill="none" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="188" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="195" y="74.0439">contextImpl</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="84" x="188" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="70" x="195" y="1252.0767">contextImpl</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="352" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="359" y="74.0439">LoadedApk</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="86" x="352" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="359" y="1252.0767">LoadedApk</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="509.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="516.5" y="74.0439">ServiceDispatcher</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="129" x="509.5" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="115" x="516.5" y="1252.0767">ServiceDispatcher</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="684" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="691" y="74.0439">InnerConnection</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="684" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="691" y="1252.0767">InnerConnection</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="844.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="851.5" y="74.0439">ActivityManagerService</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="844.5" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="147" x="851.5" y="1252.0767">ActivityManagerService</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="1019.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1026.5" y="74.0439">ActiveServices</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="106" x="1019.5" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1026.5" y="1252.0767">ActiveServices</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="1270.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1277.5" y="74.0439">ActivityThread</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="104" x="1270.5" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1277.5" y="1252.0767">ActivityThread</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="1454" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1461" y="74.0439">Handler</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="1454" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="49" x="1461" y="1252.0767">Handler</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1531" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1538" y="74.0439">ServiceConnection</text><rect fill="#FEFECE" filter="url(#fghnl0vzlw4rj)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1531" y="1229.0327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1538" y="1252.0767">ServiceConnection</text><polygon fill="#A80036" points="220,118.1201,230,122.1201,220,126.1201,224,122.1201" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="35" x2="226" y1="122.1201" y2="122.1201"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="42" y="118.0181">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="75" y="118.0181">bindService()启动service</text><path d="M99,135.8745 L99,198.8745 L360,198.8745 L360,145.8745 L350,135.8745 L99,135.8745 " fill="#00FFFF" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M350,135.8745 L350,145.8745 L360,145.8745 L350,135.8745 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="105" y="155.7725">这个是contextImpl是context的具体实现，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="105" y="173.5269">在activity中startService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="105" y="191.2813">其实是调用contextImpl的startService()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="232" x2="274" y1="231.8921" y2="231.8921"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="274" x2="274" y1="231.8921" y2="244.8921"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="233" x2="274" y1="244.8921" y2="244.8921"/><polygon fill="#A80036" points="243,240.8921,233,244.8921,243,248.8921,239,244.8921" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="239" y="227.0356">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="272" y="227.0356">bindServiceCommon</text><polygon fill="#A80036" points="385,271.8921,395,275.8921,385,279.8921,389,275.8921" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="232" x2="391" y1="275.8921" y2="275.8921"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="239" y="271.79">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="276" y="271.79"/><polygon fill="#A80036" points="564,303.6465,574,307.6465,564,311.6465,568,307.6465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="570" y1="307.6465" y2="307.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="404" y="303.5444">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="437" y="303.5444">getServiceDispatcher</text><polygon fill="#A80036" points="733,335.4009,743,339.4009,733,343.4009,737,339.4009" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="576" x2="739" y1="339.4009" y2="339.4009"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="583" y="335.2988">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="616" y="335.2988">ServiceDispatcher()</text><path d="M504,353.1553 L504,487.1553 L981,487.1553 L981,363.1553 L971,353.1553 L504,353.1553 " fill="#00FFFF" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M971,353.1553 L971,363.1553 L981,363.1553 L971,353.1553 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="510" y="373.0532">InnerConnection extends IServiceConnection.Stub {}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="510" y="390.8076">这里继承了IServiceConnection.Stub,说明他是一个AIDL。</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="510" y="408.562">这里解释一下为什么不能直接使用ServiceConnection对象，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="510" y="426.3164">这是因为服务的绑定有可能是跨进程的，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="456" x="510" y="444.0708">因此ServiceConnection对象必须借助于Binder才能让远程服务回调自己的方法，</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="510" y="461.8252">而ServiceDispatcher的内部类InnerConnection刚好充当了Binder这个角色</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="510" y="479.5796">ServiceConnection只是一个接口</text><path d="M353,501.436 L353,564.436 L795,564.436 L795,511.436 L785,501.436 L353,501.436 " fill="#00FFFF" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M785,501.436 L785,511.436 L795,511.436 L785,501.436 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="363" y="521.334"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="359" y="539.0884">那么ServiceDispatcher的作用是什么呢？</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="421" x="359" y="556.8428">其实ServiceDispatcher起连接ServiceConnection和InnerConnection的作用</text><polygon fill="#A80036" points="915,592.6992,925,596.6992,915,600.6992,919,596.6992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="232" x2="921" y1="596.6992" y2="596.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="239" y="592.5972">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="272" y="592.5972">ActivityManager.getService()</text><polygon fill="#A80036" points="1062.5,624.4536,1072.5,628.4536,1062.5,632.4536,1066.5,628.4536" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="927" x2="1068.5" y1="628.4536" y2="628.4536"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="934" y="624.3516">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="967" y="624.3516">bindService</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1074.5" x2="1116.5" y1="660.9624" y2="660.9624"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1116.5" x2="1116.5" y1="660.9624" y2="673.9624"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1075.5" x2="1116.5" y1="673.9624" y2="673.9624"/><polygon fill="#A80036" points="1085.5,669.9624,1075.5,673.9624,1085.5,677.9624,1081.5,673.9624" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1081.5" y="656.106">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="1114.5" y="656.106">bindServiceLocked</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1074.5" x2="1116.5" y1="705.7168" y2="705.7168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1116.5" x2="1116.5" y1="705.7168" y2="718.7168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1075.5" x2="1116.5" y1="718.7168" y2="718.7168"/><polygon fill="#A80036" points="1085.5,714.7168,1075.5,718.7168,1085.5,722.7168,1081.5,718.7168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1081.5" y="700.8604">[009]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1114.5" y="700.8604">bringUpServiceLocked</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1074.5" x2="1116.5" y1="750.4712" y2="750.4712"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1116.5" x2="1116.5" y1="750.4712" y2="763.4712"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1075.5" x2="1116.5" y1="763.4712" y2="763.4712"/><polygon fill="#A80036" points="1085.5,759.4712,1075.5,763.4712,1085.5,767.4712,1081.5,763.4712" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1081.5" y="745.6147">[010]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1114.5" y="745.6147">realStartServiceLocked</text><path d="M877,776.4712 L877,857.4712 L1267,857.4712 L1267,786.4712 L1257,776.4712 L877,776.4712 " fill="#00FFFF" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1257,776.4712 L1257,786.4712 L1267,786.4712 L1257,776.4712 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="883" y="796.3691">realStartServiceLocked 是不是很熟悉</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="329" x="883" y="814.1235">又是一个类似的东西,这个和start方法调用的是同一个方法</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="883" y="831.8779">但是怎么就变成bind方法了呢，前面在bindServiceLocked</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="883" y="849.6323">这个方法内部还调用了其他的方法:requestServiceBindingLocked</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1074.5" x2="1116.5" y1="890.2432" y2="890.2432"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1116.5" x2="1116.5" y1="890.2432" y2="903.2432"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1075.5" x2="1116.5" y1="903.2432" y2="903.2432"/><polygon fill="#A80036" points="1085.5,899.2432,1075.5,903.2432,1085.5,907.2432,1081.5,903.2432" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1081.5" y="885.3867">[011]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="1114.5" y="885.3867">requestServiceBindingLocked</text><polygon fill="#A80036" points="1312.5,930.2432,1322.5,934.2432,1312.5,938.2432,1316.5,934.2432" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1074.5" x2="1318.5" y1="934.2432" y2="934.2432"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1081.5" y="930.1411">[012]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="1114.5" y="930.1411">r.app.thread.scheduleBindService</text><path d="M1185,947.9976 L1185,974.9976 L1459,974.9976 L1459,957.9976 L1449,947.9976 L1185,947.9976 " fill="#00FFFF" filter="url(#fghnl0vzlw4rj)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1449,947.9976 L1449,957.9976 L1459,957.9976 L1449,947.9976 " fill="#00FFFF" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="1191" y="967.8955">这里回到ActivityThread中通过handler来处理</text><polygon fill="#A80036" points="1475.5,1003.752,1485.5,1007.752,1475.5,1011.752,1479.5,1007.752" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1324.5" x2="1481.5" y1="1007.752" y2="1007.752"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1331.5" y="1003.6499">[013]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="1364.5" y="1003.6499">sendMessage</text><polygon fill="#A80036" points="1335.5,1035.5063,1325.5,1039.5063,1335.5,1043.5063,1331.5,1039.5063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1329.5" x2="1486.5" y1="1039.5063" y2="1039.5063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="1341.5" y="1035.4043">[014]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="1374.5" y="1035.4043">handleBindService</text><polygon fill="#A80036" points="938,1067.2607,928,1071.2607,938,1075.2607,934,1071.2607" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="932" x2="1323.5" y1="1071.2607" y2="1071.2607"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="944" y="1067.1587">[015]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="977" y="1067.1587">publishService</text><polygon fill="#A80036" points="756,1099.0151,746,1103.0151,756,1107.0151,752,1103.0151" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="750" x2="926" y1="1103.0151" y2="1103.0151"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="762" y="1098.9131">[016]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="795" y="1098.9131">publishServiceLocked</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="745" x2="787" y1="1135.5239" y2="1135.5239"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="787" x2="787" y1="1135.5239" y2="1148.5239"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="746" x2="787" y1="1148.5239" y2="1148.5239"/><polygon fill="#A80036" points="756,1144.5239,746,1148.5239,756,1152.5239,752,1148.5239" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="752" y="1130.6675">[017]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="785" y="1130.6675">connected</text><polygon fill="#A80036" points="587,1175.5239,577,1179.5239,587,1183.5239,583,1179.5239" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="581" x2="744" y1="1179.5239" y2="1179.5239"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="593" y="1175.4219">[018]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="626" y="1175.4219">doConnected</text><polygon fill="#A80036" points="1587.5,1207.2783,1597.5,1211.2783,1587.5,1215.2783,1591.5,1211.2783" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="576" x2="1593.5" y1="1211.2783" y2="1211.2783"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="583" y="1207.1763">[019]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="200" x="616" y="1207.1763">onServiceConnected 服务连接成功</text><!--
@startuml
actor Context #red
autonumber 1 1 "<b>[000]"

Context->contextImpl:bindService()启动service
note over of contextImpl #aqua
这个是contextImpl是context的具体实现，
在activity中startService
其实是调用contextImpl的startService()
end note
contextImpl->contextImpl:bindServiceCommon
contextImpl->LoadedApk
LoadedApk->ServiceDispatcher:getServiceDispatcher
ServiceDispatcher->InnerConnection:ServiceDispatcher()
note over of InnerConnection #aqua
InnerConnection extends IServiceConnection.Stub {}
这里继承了IServiceConnection.Stub,说明他是一个AIDL。
这里解释一下为什么不能直接使用ServiceConnection对象，
这是因为服务的绑定有可能是跨进程的，
因此ServiceConnection对象必须借助于Binder才能让远程服务回调自己的方法，
而ServiceDispatcher的内部类InnerConnection刚好充当了Binder这个角色
ServiceConnection只是一个接口
end note
note over of ServiceDispatcher #aqua

那么ServiceDispatcher的作用是什么呢？
其实ServiceDispatcher起连接ServiceConnection和InnerConnection的作用
end note
contextImpl->ActivityManagerService:ActivityManager.getService()
ActivityManagerService->ActiveServices:bindService
ActiveServices->ActiveServices:bindServiceLocked
ActiveServices->ActiveServices:bringUpServiceLocked
ActiveServices->ActiveServices:realStartServiceLocked
note over of ActiveServices #aqua
realStartServiceLocked 是不是很熟悉
又是一个类似的东西,这个和start方法调用的是同一个方法
但是怎么就变成bind方法了呢，前面在bindServiceLocked
这个方法内部还调用了其他的方法:requestServiceBindingLocked
end note
ActiveServices->ActiveServices:requestServiceBindingLocked
ActiveServices->ActivityThread:r.app.thread.scheduleBindService
note over of ActivityThread #aqua
这里回到ActivityThread中通过handler来处理
end note
ActivityThread->Handler:sendMessage
Handler->ActivityThread:handleBindService
ActivityThread->ActivityManagerService:publishService
ActivityManagerService->InnerConnection:publishServiceLocked
InnerConnection->InnerConnection:connected
InnerConnection->ServiceDispatcher:doConnected
ServiceDispatcher->ServiceConnection:onServiceConnected 服务连接成功
autonumber stop
@enduml

PlantUML version 1.2018.01(Mon Jan 29 02:08:22 GMT+08:00 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1024-b02
Operating System: Windows 10
OS Version: 10.0
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>