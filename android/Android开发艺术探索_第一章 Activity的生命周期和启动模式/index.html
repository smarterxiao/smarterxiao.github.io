<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="进阶,Android开发艺术探索," />










<meta name="description" content="Android 的生命周期全面分析正常情况下的生命周期分析 onCreate : 这个表示Activity正在被创建，是整个生命周期的第一个方法，在这个方法中，我们可以做一些初始化工作，比如调用setContentView去加载界面布局资源，初始化Activity所需要的数据。  onRestart : 这个表示Activity正在重新启动，一般情况下，当前Activtiy从不可见重新变为可见状态">
<meta name="keywords" content="进阶,Android开发艺术探索">
<meta property="og:type" content="article">
<meta property="og:title" content="Android开发艺术探索 第一章 Activity的生命周期和启动模式">
<meta property="og:url" content="http://yoursite.com/android/Android开发艺术探索_第一章 Activity的生命周期和启动模式/index.html">
<meta property="og:site_name" content="个人网站">
<meta property="og:description" content="Android 的生命周期全面分析正常情况下的生命周期分析 onCreate : 这个表示Activity正在被创建，是整个生命周期的第一个方法，在这个方法中，我们可以做一些初始化工作，比如调用setContentView去加载界面布局资源，初始化Activity所需要的数据。  onRestart : 这个表示Activity正在重新启动，一般情况下，当前Activtiy从不可见重新变为可见状态">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/android/Android开发艺术探索_第一章%20Activity的生命周期和启动模式/activity_lifecycle.png">
<meta property="og:image" content="http://yoursite.com/android/Android开发艺术探索_第一章%20Activity的生命周期和启动模式/图像1517055460.png">
<meta property="og:updated_time" content="2018-07-26T13:02:16.357Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android开发艺术探索 第一章 Activity的生命周期和启动模式">
<meta name="twitter:description" content="Android 的生命周期全面分析正常情况下的生命周期分析 onCreate : 这个表示Activity正在被创建，是整个生命周期的第一个方法，在这个方法中，我们可以做一些初始化工作，比如调用setContentView去加载界面布局资源，初始化Activity所需要的数据。  onRestart : 这个表示Activity正在重新启动，一般情况下，当前Activtiy从不可见重新变为可见状态">
<meta name="twitter:image" content="http://yoursite.com/android/Android开发艺术探索_第一章%20Activity的生命周期和启动模式/activity_lifecycle.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/android/Android开发艺术探索_第一章 Activity的生命周期和启动模式/"/>





  <title>Android开发艺术探索 第一章 Activity的生命周期和启动模式 | 个人网站</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人网站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/android/Android开发艺术探索_第一章 Activity的生命周期和启动模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Groot">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人网站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android开发艺术探索 第一章 Activity的生命周期和启动模式</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-27T17:08:20+08:00">
                2018-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Android-的生命周期全面分析"><a href="#Android-的生命周期全面分析" class="headerlink" title="Android 的生命周期全面分析"></a>Android 的生命周期全面分析</h1><h2 id="正常情况下的生命周期分析"><a href="#正常情况下的生命周期分析" class="headerlink" title="正常情况下的生命周期分析"></a>正常情况下的生命周期分析</h2><ul>
<li><p>onCreate : 这个表示Activity正在被创建，是整个生命周期的第一个方法，在这个方法中，我们可以做一些初始化工作，比如调用setContentView去加载界面布局资源，初始化Activity所需要的数据。</p>
</li>
<li><p>onRestart : 这个表示Activity正在重新启动，一般情况下，当前Activtiy从不可见重新变为可见状态的的时候Onrestart就会被重新调用，这个一般是用户行为导致的。</p>
</li>
<li><p>onStart : 这个表示Activity正在被启动，即将开始，这个时候Activity已经可见了，但是还没有出现在前台，无法和用户交互，这个时候其实可以理解为Activity已经显示出来了，但是我们看不到</p>
</li>
</ul>
<ul>
<li><p>onResume 表明Activity已经可见了，并且出现在前台并且开始活动，注意这个和onStart的对比，这两个都表示Activity已经可见，但是Onstart的时候Activity还在后台，onResume之后Activity才显示到前台</p>
</li>
<li><p>onPause 表明Activity正在停止，正常情况下，紧接着onStop会被调用，特殊的，如果这个时候在快速货到当前Activity，那么onResume方法会被调用，这种属于极端情况，用户操作很难重现这一个场景，此时可以做到存储一些数据，停止一些动画的操作。onPause必须先执行完毕，新的Activity的onResume方法才会执行</p>
</li>
<li><p>onStop 表示Activity即将停止，可以做一些稍微重量级的回收工作，但是不能太耗时</p>
</li>
<li><p>onDestory 表示Activity即将被销毁，这是Activity生命周期中的最后一个回调，在这里，我们可以做一些回收工作，并最终释放资源</p>
</li>
</ul>
<p>可以看一下下面这张图，这个是Google放出的Activity生命周期的切换过程</p>
<p><img src="activity_lifecycle.png" alt="Alt text" title="Android 生命周期"></p>
<p>这里在做一些特殊的说明</p>
<ol>
<li><p>针对一个特定的Activity，第一次启动，回调如下：oncreate–&gt; onStart –&gt; onResume</p>
</li>
<li><p>当用户打开新的Activity或者切换到桌面的时候，回调如下：<code>onPause</code>-&gt;<code>onStop</code> 还有一种特殊的情况，如果新的Activity采用透明的主题，那么当前Activity会不会调用<code>onStop</code></p>
</li>
<li><p>当用户再次回到原Activity时，回调如下：onRestart-&gt;onStart-&gt;onResume</p>
</li>
<li><p>当用户按back键回退时，回调如下:onPause-&gt;onStop-&gt;onDestory</p>
</li>
<li><p>当Activity被系统回收之后再次打开的时候，生命周期方法回调过程和(1)一样，注意是生命周期方法一样，不代表所有过程都一样。</p>
</li>
<li><p>从整个生命周期来讲，<code>onCreate</code>和<code>onDestory</code>是配对的。分别表示这Activity的勾线和销毁，并且只有可能有一次调用。从Activity时候可见来讲，<code>onStart</code>和<code>onStop</code>是配对的，随着用户的操作或者设备屏幕的点亮与熄灭，这两个方法可能会被调用多次，从Activity时候在前台来说，<code>onResume</code>和<code>onPause</code>是配对的，随着用户的操作或者设备屏幕的点亮和熄灭被调用多次</p>
</li>
</ol>
<p><code>onStart</code>和<code>onResume</code>、<code>onPause</code>和<code>onStop</code>在描述上来讲是差不多的，但是他们描述的东西在维度上是有区别的，<code>onStart</code>和<code>onStop</code>是从Activity是否可见这个角度来描述的，而<code>onResume</code>和<code>onPause</code>是用Activity是否位于前台这个角度来描述的，在实际使用中并没有明显的区别。</p>
<p>如果A <code>Activity</code> 启动B<code>Activity</code> 那么是Bactivity的<code>onResume</code>先执行还是A的<code>onPause</code>先执行？这个要看一下源码，是先执行A<code>Activity</code>的<code>onPause</code> 在执行B<code>Activity</code>的onResume</p>
<h2 id="异常情况下的生命周期方法周期分析"><a href="#异常情况下的生命周期方法周期分析" class="headerlink" title="异常情况下的生命周期方法周期分析"></a>异常情况下的生命周期方法周期分析</h2><h4 id="资源相关的系统配置发生改变导致Activity被杀死并重新创建"><a href="#资源相关的系统配置发生改变导致Activity被杀死并重新创建" class="headerlink" title="资源相关的系统配置发生改变导致Activity被杀死并重新创建"></a>资源相关的系统配置发生改变导致Activity被杀死并重新创建</h4><p>比较典型的一个例子是手机的横竖屏切换，但是这个时候会问为什么会在旋转屏幕的时候会杀死当前的Activity并创建新的Activity。这个是为了资源的适配。举一个例子，就拿图片来讲，我们把一张图片放在一个drawable目录，为了兼容不同的设备，会在其他目录放一些图片，eg：drawable-mdpi，drawable-hdpi，drawable-land等这样在程序启动的时候，系统会根据不同的设备加载适合的resource资源，比如横屏和竖屏的情况会拿到不同的两张图片(设定了landscape或者portrait状态下的图片)，所以在旋转屏幕的时候会销毁Activity并重新创建，来加载不同的文件。<br>如果我们不作特殊的处理，就会产生如下的生命周期</p>
<p><img src="图像1517055460.png" alt="Alt text" title="Android 异常状态下的生命周期"></p>
<p>在Activity的<code>onStop</code>调用之前会先调用<code>onSaveInstanceState</code>方法保存当前Activity的状态，但是<code>onSaveInstanceState</code>和<code>onPause</code>的调用没有既定的时序相关，可以在<code>onPause</code>之后调用，也可以在<code>onPause</code>之前调用。在Activity创建之后，系统会调用<code>onRestoreInstanceState</code>将之前在<code>onSaveInstanceState</code>保存的Bundle传递过来，这个时候可以在<code>onCreate</code>和<code>onRestoreInstanceState</code>中判断当前Activity是否是被重建，如果被重建，Bundle参数就不为空。从时序上来讲，<code>onRestoreInstanceState</code>的调用时机在<code>onStart</code>之后</p>
<p>同时，我们要知道，在<code>onSaveInstanceState</code>和<code>onRestoreInstanceState</code>方法中，系统自动为我们做了一些恢复工作。当Activity在异常情况下需要重新创建是，系统会为我们保存当前Activity的数据结构，并且在Activity重启后为我们恢复这些数据，例如EditText,ListView滚动位置…。</p>
<p>具体保存的工作流程是这样的。Activity被意外终止的时候，Activity会调用<code>onSaveInstanceState</code>去保存数据，然后Activity会委托Window去保存数据，接着Window会委托他上面的顶级容器去保存数据。顶层容器是一个ViewGroup，一般来说他很有可能是DecordView，最后顶层容器在去意义通过直他的子元素来保存数据，这个时候整个数据的保存过程就完成了。其实可以发现，这是一种典型的委托思想，上曾委托下层，这种思想在Android中有很多的运用，比如View的绘制和事件的分发。可以点击TextView,查看他的<code>onSaveInstanceState</code>这个方法就可以知道他会保存那些数据了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        if(savedInstanceState!=null)&#123;</span><br><span class="line">        String test=    savedInstanceState.getString(&quot;extra_test&quot;);</span><br><span class="line">            Log.i(&quot;Tag&quot;,&quot;&quot;+test);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void onSaveInstanceState(Bundle outState, PersistableBundle outPersistentState) &#123;</span><br><span class="line">        super.onSaveInstanceState(outState, outPersistentState);</span><br><span class="line">        outState.putString(&quot;extra_test&quot;,&quot;天气&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected void onRestoreInstanceState(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onRestoreInstanceState(savedInstanceState);</span><br><span class="line">        String test=    savedInstanceState.getString(&quot;extra_test&quot;);</span><br><span class="line">        Log.i(&quot;Tag&quot;,&quot;&quot;+test);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onRestoreInstanceState</code>这个方法被调用，那么他的Bundle一定不为空，但是<code>onCreate</code>被调用，如果要用到Bundle，那么要判断非空状态，这两个方法选择任意的都可以恢复数据，但是官方建议我们使用<code>onRestoreInstanceState</code>去恢复数据。<code>onSaveInstanceState</code>这个方法还有一点要补充的就是如果Activity是正常销毁的，就不会调用这个方法。</p>
<h4 id="资源内存不足导致低优先级的Activity被杀死"><a href="#资源内存不足导致低优先级的Activity被杀死" class="headerlink" title="资源内存不足导致低优先级的Activity被杀死"></a>资源内存不足导致低优先级的Activity被杀死</h4><p>这里先来讲一下Android Activity的优先级</p>
<table>
<thead>
<tr>
<th>状态</th>
<th style="text-align:center">解释</th>
<th style="text-align:center">优先级，小的优先级高</th>
</tr>
</thead>
<tbody>
<tr>
<td>前台Activity</td>
<td style="text-align:center">正在和用户交互的Activity</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td>非前台，但是可见的Activity</td>
<td style="text-align:center">比如在Activity中弹出一个对话框，导致Activity可见，但是在后台无法和用户交互</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td>后台Activity</td>
<td style="text-align:center">调用了onStop的</td>
<td style="text-align:center">3</td>
</tr>
</tbody>
</table>
<p>当系统内存不足的时候，系统会先杀死目标Activity所在的进程，并陆续调用<code>onSaveInstanceState</code>和<code>onRestoreInstanceState</code>来保存和恢复数据。如果一个进程中没有四大组件在运行，那么这个进程将很容易被杀死，因此，一些后台工作不适合脱离四大组件单独运行在后天中，这样进程很容易被杀死。最好是在Service中进行，从而保持一定的优先级，避免被系统杀死。</p>
<p>Android进程优先级从高到底 <a href="https://developer.android.com/guide/components/processes-and-threads.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/guide/components/processes-and-threads.html?hl=zh-cn</a></p>
<ul>
<li><p>前台进程<br>用户当前操作所必需的进程。如果一个进程满足以下任一条件，即视为前台进程：</p>
<ul>
<li>托管用户正在交互的 Activity（已调用 Activity 的 onResume() 方法）</li>
<li>托管某个 Service，后者绑定到用户正在交互的 Activity</li>
<li>托管正在“前台”运行的 Service（服务已调用 startForeground()）</li>
<li>托管正执行一个生命周期回调的 Service（onCreate()、onStart() 或 onDestroy()）</li>
<li>托管正执行其 onReceive() 方法的 BroadcastReceiver<br>通常，在任意给定时间前台进程都为数不多。只有在内存不足以支持它们同时继续运行这一万不得已的情况下，系统才会终止它们。 此时，设备往往已达到内存分页状态，因此需要终止一些前台进程来确保用户界面正常响应。</li>
</ul>
</li>
<li><p>可见进程</p>
</li>
</ul>
<p>没有任何前台组件、但仍会影响用户在屏幕上所见内容的进程。 如果一个进程满足以下任一条件，即视为可见进程：</p>
<ul>
<li>托管不在前台、但仍对用户可见的 Activity（已调用其 onPause() 方法）。例如，如果前台 Activity 启动了一个对话框，允许在其后显示上一 Activity，则有可能会发生这种情况。</li>
<li>托管绑定到可见（或前台）Activity 的 Service。<br>可见进程被视为是极其重要的进程，除非为了维持所有前台进程同时运行而必须终止，否则系统不会终止这些进程。</li>
</ul>
<ul>
<li><p>服务进程<br>正在运行已使用 startService() 方法启动的服务且不属于上述两个更高类别进程的进程。尽管服务进程与用户所见内容没有直接关联，但是它们通常在执行一些用户关心的操作（例如，在后台播放音乐或从网络下载数据）。因此，除非内存不足以维持所有前台进程和可见进程同时运行，否则系统会让服务进程保持运行状态。</p>
</li>
<li><p>后台进程<br>包含目前对用户不可见的 Activity 的进程（已调用 Activity 的 onStop() 方法）。这些进程对用户体验没有直接影响，系统可能随时终止它们，以回收内存供前台进程、可见进程或服务进程使用。 通常会有很多后台进程在运行，因此它们会保存在 LRU （最近最少使用）列表中，以确保包含用户最近查看的 Activity 的进程最后一个被终止。如果某个 Activity 正确实现了生命周期方法，并保存了其当前状态，则终止其进程不会对用户体验产生明显影响，因为当用户导航回该 Activity 时，Activity 会恢复其所有可见状态。 有关保存和恢复状态的信息，</p>
</li>
<li><p>空进程<br>不含任何活动应用组件的进程。保留这种进程的的唯一目的是用作缓存，以缩短下次在其中运行组件所需的启动时间。 为使总体系统资源在进程缓存和底层内核缓存之间保持平衡，系统往往会终止这些进程。</p>
</li>
</ul>
<p>从服务进程开始，一般是不会被系统杀死的，但是这个还要看国内各种不同Rom的优化了。</p>
<p>如果重新创建Activity，就在清单文件中为activity添加<code>android：configChanges=&quot;orientaion&quot;</code></p>
<h1 id="Activity的启动模式"><a href="#Activity的启动模式" class="headerlink" title="Activity的启动模式"></a>Activity的启动模式</h1><h2 id="Activity的LaunchMode"><a href="#Activity的LaunchMode" class="headerlink" title="Activity的LaunchMode"></a>Activity的LaunchMode</h2><ul>
<li>standard<br>标准模式，这个是系统的默认模式。在这种模式下，Activity  A启动了Activity B ，那么B就会进入到A的Activity。如果是使用ApplicationContext去启动standard模式的Activitty就会报错。这个是应为standard模式的activity默认会进入启动它的activity所属的任务栈，但是由于非Activity类型的Context并没有任务栈，所以就有问题了，这个是有就需要在启动的时候之指定FLAG_ACTIVITY_NEW_TASK标记位，这样启动的时候就会为他创建一个新的任务栈。这个时候启动的Activity实际上是一个singleTask模式启动的。</li>
<li>singleTop<br>栈顶复用模式。类似standard模式，但是区别是如果这个activity在栈顶，就不会创建。但是会回调他的<code>onNewItent</code>方法</li>
<li>singleTask<br>栈内复用模式。这是一种单实例模式，在这种模式下，只要Activity在一个栈中存在，那么多次启动此Activity都不会重新创建实例，和singleTop一样，会回调<code>onNewItent</code>方法。具体的，当启动一个具有singleTask模式的Activity，比如Activity A，这个时候系统会寻找时候存在A想要的任务栈，如果不存在，就重新创建一个任务栈，然后创建A并把A实例放入栈中。如果存在A所需要的任务栈，那么久这是要看任务栈中有没有实例A，如果有，就把A调到栈顶，并调用<code>onNewIntent</code>方法，如果不存在，就创建并把A压入栈中。<br>举个例子<br>比如任务栈S1目前的情况是ABC，这个时候Activity D用singleTask模式请求启动。<br>第一种情况。 其所需要的任务栈是S2.由于S2和D实例均不存在，这个时候会创建任务栈S2，并创建D将D压入S2<br>第二种情况，假设D所需要的任务栈是S1，那么S1已经存在，就会直接创建D并压入S1<br>第三种情况，如果D所需要的任务栈是S1，并且当前任务栈S1的情况为ADBC，那么根据栈内复用原则，就不会创建D，而是把D切换到栈顶，调用其<code>onNewIntent</code>方法，同时由于singleTask默认具有clearTop效果，会导致D上面的Activity全部出栈，最终S1中的情况是AD</li>
<li>singleInstance<br>单实例模式。这个是对singleTask的加强版，除了具有singleTask所有的属性外，还加强了一点，那就是具有这种模式的Activity只能单独的存在一个任务栈中，换句话说，如果Activity A 具有singleInstance模式，当A启动后，系统会为他创建一个新的Activity任务栈，然后这个A单独存在这个任务栈，由于栈内复用的特性，后续君不悔创建新的activity，除非这个独特的任务栈被系统销毁了。</li>
</ul>
<p>上面介绍了几种启动模式，这里需要指出的一种情况，假设我们目前有两个任务栈，前台任务栈的情况是AB，后台任务栈的情况是CD，假设CD的启动模式均为singleTask。现在启动D，那么整个后台任务栈就会被切换到前台，这个时候后退列表就变成了ABCD，当用户按back的时候，ABCD会一一出栈。这个时候如果启动的是C，就不一样了，C是singleTask的，会把D出栈，这个时候就只剩下ABC了。</p>
<p>这里有一个概念就是Activity任务栈，这个是什么呢?这个就要从一个参数说起TaskAffinity可以翻译成亲和度，这个参数标记了Activity任务栈的任务栈名。默认情况下所有的Activity所需要的任务栈的名字就是应用的包名。当然，我们可以为美特Activity都单独指定TaskAffinity，这个属性一定不能喝包名相同，否则就相当于没有指定。TaskAffinity属性主要和singleTask启动模式或者allowTaskReparenting属性配对使用，在其他情况下没有意义。另外，任务栈分为浅谈任务和后台任务栈，后台任务栈中的Activity位于暂停状态，用户可以通过切换将后台任务栈再次调到前台。当TaskAffinity和singleTask启动模式配对使用的时候，他是具有改模式的Activity的目前任务栈的名字，待启动的Activity会运行在名字和TaskAffinity相同的任务栈中。当TaskAffinity和allowTaskReparenting结合的时候，这种情况比较复杂，会产生特殊的效果，当一个应用A启动了应用B中的某个Activity，如果这个Activity的allowTaskReparenting属性值为true，那么应用B被启动之后，这个Activity会直接从应用A的任务栈转移到应用B的任务栈，这个还是比较抽象，举个例子：如果现在有两个应用A和B，A启动了B的一个Activity C，然后按Home回到桌面，在点击B进入，这个时候启动的不是B的住Activity，而是会进入到被A启动的Activity，或者说C从A的任务栈转移到了B的任务栈。可以这么理解，由于A启动了C这个时候C只能运行在A的任务栈中，但是C属于B的应用，正常情况下他的TaskAffinity一定和A的任务栈不相同，因为包名不同，所以。当B被启动之后B创建自己的任务栈，这个时候系统发现C原本所想要的任务栈已经被创建了。所以就把C从A的任务栈中移动到B的任务栈中。</p>
<p>如何给Activity指定启动模式呢?有两种方法。<br>第一种是通过清单文件指定Activity启动模式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    package=&quot;com.smart.kaifa&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;application</span><br><span class="line">        android:allowBackup=&quot;true&quot;</span><br><span class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;</span><br><span class="line">        android:label=&quot;@string/app_name&quot;</span><br><span class="line">        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;</span><br><span class="line">        android:supportsRtl=&quot;true&quot;</span><br><span class="line">        android:theme=&quot;@style/AppTheme&quot;&gt;</span><br><span class="line">        &lt;activity android:name=&quot;.MainActivity&quot; android:launchMode=&quot;singleTask&quot;&gt;//在这里为Activity设置启动模式</span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line"></span><br><span class="line">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">        &lt;/activity&gt;</span><br><span class="line">    &lt;/application&gt;</span><br><span class="line"></span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure></p>
<p>另外一种是通过在Intent中设置标志位来为Activity指定启动模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent=new Intent();</span><br><span class="line">intent.setClass(MainActivity.this,SecondActivity.class);</span><br><span class="line">intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>这两种方式都可以为Activity指定启动模式，但是两者还是有区别的，首先第二种的优先级要高于第一种，当两种同时存在的时候以第二种方式为准，其次上述两种启动方式的限定范围上有所不同，比如，第一种方式无法直接为Activity设置Flag_ACTIVITY_CLEAR_TOP标识，而第二种方式无法为Activity指定singleInstance模式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        View viewById = findViewById(R.id.test);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        viewById.setOnClickListener(new View.OnClickListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onClick(View v) &#123;</span><br><span class="line">                Intent intent=new Intent();</span><br><span class="line">                intent.setClass(MainActivity.this,MainActivity.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected void onNewIntent(Intent intent) &#123;</span><br><span class="line">        super.onNewIntent(intent);</span><br><span class="line">        Log.i(&quot;哇哈哈&quot;,&quot;营养快线&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>点击四次<br>然后使用<code>adb shell dumpsys activity activitys</code>命令查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ACTIVITY MANAGER ACTIVITIES (dumpsys activity activities)</span><br><span class="line">Display #0 (activities from top to bottom):</span><br><span class="line">  Stack #1:</span><br><span class="line">  mFullscreen=true</span><br><span class="line">  mBounds=null</span><br><span class="line">    Task id #2243</span><br><span class="line">    mFullscreen=true</span><br><span class="line">    mBounds=null</span><br><span class="line">    mMinWidth=-1</span><br><span class="line">    mMinHeight=-1</span><br><span class="line">    mLastNonFullscreenBounds=null</span><br><span class="line">      TaskRecord&#123;38f09c #2243 A=com.smart.kaifa U=0 StackId=1 sz=1&#125;</span><br><span class="line">      Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] flg=0x10200000 cmp=com.smart.kaifa/.MainActivity bnds=[443,1427][667,1651] (has extras) &#125;</span><br><span class="line">        Hist #0: ActivityRecord&#123;3ab3e8d u0 com.smart.kaifa/.MainActivity t2243&#125;</span><br><span class="line">          Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] flg=0x10200000 cmp=com.smart.kaifa/.MainActivity bnds=[443,1427][667,1651] (has extras) &#125;</span><br><span class="line">          ProcessRecord&#123;6362aa5 27067:com.smart.kaifa/u0a190&#125;</span><br><span class="line"></span><br><span class="line">    Running activities (most recent first):</span><br><span class="line">      TaskRecord&#123;38f09c #2243 A=com.smart.kaifa U=0 StackId=1 sz=1&#125;//size是1</span><br><span class="line">        Run #0: ActivityRecord&#123;3ab3e8d u0 com.smart.kaifa/.MainActivity t2243&#125;//创建了一次</span><br><span class="line"></span><br><span class="line">    mResumedActivity: ActivityRecord&#123;3ab3e8d u0 com.smart.kaifa/.MainActivity t2243&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候去掉singleTask，我们点击3下，之后看一下结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ACTIVITY MANAGER RECENT TASKS (dumpsys activity recents)</span><br><span class="line">  Recent tasks:</span><br><span class="line">  * Recent #0: TaskRecord&#123;b808e48 #2245 A=com.smart.kaifa U=0 StackId=1 sz=3&#125;</span><br><span class="line">  * Recent #1: TaskRecord&#123;260611 #2237 I=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL U=0 StackId=0 sz=1&#125;</span><br><span class="line">  * Recent #2: TaskRecord&#123;8d1157c #2123 A=com.android.systemui U=0 StackId=5 sz=1&#125;</span><br><span class="line">  * Recent #3: TaskRecord&#123;82ff376 #2233 A=com.google.android.packageinstaller U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #4: TaskRecord&#123;4a7ede4 #2230 I=com.android.settings/.Settings$AppDrawOverlaySettingsActivity U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #5: TaskRecord&#123;853f24d #2185 A=com.android.vending U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #6: TaskRecord&#123;41fd102 #2184 A=com.github.shadowsocks U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #7: TaskRecord&#123;cc6ca13 #2162 A=com.clov4r.android.nil U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #8: TaskRecord&#123;fe80450 #2180 A=com.google.android.googlequicksearchbox U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #9: TaskRecord&#123;cfa6649 #2161 A=com.smart.myapplication U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #10: TaskRecord&#123;73e0af7 #2159 A=com.android.chrome U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #11: TaskRecord&#123;73dfb4e #2157 I=com.android.settings/.deviceinfo.UsbModeChooserActivity U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #12: TaskRecord&#123;449f46f #2153 A=com.qihoo.explorer U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #13: TaskRecord&#123;f7a1e05 #2002 A=com.google.android.deskclock U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #14: TaskRecord&#123;9027e5a #1993 A=com.android.documentsui U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #15: TaskRecord&#123;c2b688b #1474 A=com.google.android.GoogleCamera U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #16: TaskRecord&#123;ed80d68 #1002 A=com.google.android.apps.docs U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #17: TaskRecord&#123;c839581 #811 A=com.google.android.play.games U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #18: TaskRecord&#123;e5a2626 #726 A=com.google.android.calculator U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #19: TaskRecord&#123;b660267 #2090 A=com.xiaoji.emulator U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #20: TaskRecord&#123;1d49814 #2086 A=com.google.android.apps.messaging U=0 StackId=-1 sz=0&#125;</span><br><span class="line">  * Recent #21: TaskRecord&#123;15308bd #2061 A=cn.collect.lihua.workflow U=0 StackId=-1 sz=0&#125;</span><br><span class="line"></span><br><span class="line">ACTIVITY MANAGER ACTIVITIES (dumpsys activity activities)</span><br><span class="line">Display #0 (activities from top to bottom):</span><br><span class="line">  Stack #1:</span><br><span class="line">  mFullscreen=true</span><br><span class="line">  mBounds=null</span><br><span class="line">    Task id #2245</span><br><span class="line">    mFullscreen=true</span><br><span class="line">    mBounds=null</span><br><span class="line">    mMinWidth=-1</span><br><span class="line">    mMinHeight=-1</span><br><span class="line">    mLastNonFullscreenBounds=null</span><br><span class="line">      TaskRecord&#123;b808e48 #2245 A=com.smart.kaifa U=0 StackId=1 sz=3&#125; //这里的size是3</span><br><span class="line">      Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] flg=0x10000000 cmp=com.smart.kaifa/.MainActivity &#125;</span><br><span class="line">        Hist #2: ActivityRecord&#123;f3f1b1b u0 com.smart.kaifa/.MainActivity t2245&#125;</span><br><span class="line">          Intent &#123; cmp=com.smart.kaifa/.MainActivity &#125;</span><br><span class="line">          ProcessRecord&#123;4c6b4e1 27837:com.smart.kaifa/u0a190&#125;</span><br><span class="line">        Hist #1: ActivityRecord&#123;2745f46 u0 com.smart.kaifa/.MainActivity t2245&#125;</span><br><span class="line">          Intent &#123; cmp=com.smart.kaifa/.MainActivity &#125;</span><br><span class="line">          ProcessRecord&#123;4c6b4e1 27837:com.smart.kaifa/u0a190&#125;</span><br><span class="line">        Hist #0: ActivityRecord&#123;1a44344 u0 com.smart.kaifa/.MainActivity t2245&#125;</span><br><span class="line">          Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] flg=0x10000000 cmp=com.smart.kaifa/.MainActivity &#125;</span><br><span class="line">          ProcessRecord&#123;4c6b4e1 27837:com.smart.kaifa/u0a190&#125;</span><br><span class="line"></span><br><span class="line">    Running activities (most recent first):</span><br><span class="line">      TaskRecord&#123;b808e48 #2245 A=com.smart.kaifa U=0 StackId=1 sz=3&#125;    //这里的size是3</span><br><span class="line">        Run #2: ActivityRecord&#123;f3f1b1b u0 com.smart.kaifa/.MainActivity t2245&#125;//创建了3次</span><br><span class="line">        Run #1: ActivityRecord&#123;2745f46 u0 com.smart.kaifa/.MainActivity t2245&#125;</span><br><span class="line">        Run #0: ActivityRecord&#123;1a44344 u0 com.smart.kaifa/.MainActivity t2245&#125;</span><br><span class="line"></span><br><span class="line">    mResumedActivity: ActivityRecord&#123;f3f1b1b u0 com.smart.kaifa/.MainActivity t2245&#125;</span><br><span class="line"></span><br><span class="line">  Stack #0:</span><br><span class="line">  mFullscreen=true</span><br><span class="line">  mBounds=null</span><br><span class="line">    Task id #2237</span><br><span class="line">    mFullscreen=true</span><br><span class="line">    mBounds=null</span><br><span class="line">    mMinWidth=-1</span><br><span class="line">    mMinHeight=-1</span><br><span class="line">    mLastNonFullscreenBounds=null</span><br><span class="line">      TaskRecord&#123;260611 #2237 I=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL U=0 StackId=0 sz=1&#125;</span><br><span class="line">      Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.HOME] flg=0x10000100 cmp=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL &#125;</span><br><span class="line">        Hist #0: ActivityRecord&#123;29147a2 u0 com.google.android.googlequicksearchbox/com.google.android.launcher.GEL t2237&#125;</span><br><span class="line">          Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.HOME] flg=0x10000100 cmp=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL &#125;</span><br><span class="line">          ProcessRecord&#123;18f4383 3903:com.google.android.googlequicksearchbox/u0a43&#125;</span><br><span class="line"></span><br><span class="line">    Running activities (most recent first):</span><br><span class="line">      TaskRecord&#123;260611 #2237 I=com.google.android.googlequicksearchbox/com.google.android.launcher.GEL U=0 StackId=0 sz=1&#125;</span><br><span class="line">        Run #0: ActivityRecord&#123;29147a2 u0 com.google.android.googlequicksearchbox/com.google.android.launcher.GEL t2237&#125;</span><br><span class="line"></span><br><span class="line">  Stack #5:</span><br><span class="line">  mFullscreen=true</span><br><span class="line">  mBounds=null</span><br><span class="line">    Task id #2123</span><br><span class="line">    mFullscreen=true</span><br><span class="line">    mBounds=null</span><br><span class="line">    mMinWidth=-1</span><br><span class="line">    mMinHeight=-1</span><br><span class="line">    mLastNonFullscreenBounds=null</span><br><span class="line">      TaskRecord&#123;8d1157c #2123 A=com.android.systemui U=0 StackId=5 sz=1&#125;</span><br><span class="line">      Intent &#123; flg=0x10804000 cmp=com.android.systemui/.recents.RecentsActivity &#125;</span><br><span class="line">        Hist #0: ActivityRecord&#123;bd08853 u0 com.android.systemui/.recents.RecentsActivity t2123&#125;</span><br><span class="line">          Intent &#123; flg=0x10804000 cmp=com.android.systemui/.recents.RecentsActivity &#125;</span><br><span class="line">          ProcessRecord&#123;ac18393 4823:com.android.systemui/u0a39&#125;</span><br><span class="line"></span><br><span class="line">    Running activities (most recent first):</span><br><span class="line">      TaskRecord&#123;8d1157c #2123 A=com.android.systemui U=0 StackId=5 sz=1&#125;</span><br><span class="line">        Run #0: ActivityRecord&#123;bd08853 u0 com.android.systemui/.recents.RecentsActivity t2123&#125;</span><br></pre></td></tr></table></figure>
<p>看一下 Running activities (most recent first): 这个后面跟着的东西<br>这里表明，现在有3个任务栈，一个任务栈的taskAffinity是com.smart.kaifa，一个任务栈的taskAffinity是com.android.systemui，另外一个任务栈的taskAffinity是com.google.android.googlequicksearchbox，这里可以看到com.smart.kaifa中有3个MainActivity，这里就印证了上面的内容</p>
<p>还有一个singleTask要说的<br>这里创建3个Activity：A、B、C分别对应MainActivity，SecondActivity，ThirdActivity<br>看一下清单文件的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    package=&quot;com.smart.kaifa&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;application</span><br><span class="line">        android:allowBackup=&quot;true&quot;</span><br><span class="line">        android:icon=&quot;@mipmap/ic_launcher&quot;</span><br><span class="line">        android:label=&quot;@string/app_name&quot;</span><br><span class="line">        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;</span><br><span class="line">        android:supportsRtl=&quot;true&quot;</span><br><span class="line">        android:theme=&quot;@style/AppTheme&quot;&gt;</span><br><span class="line">        &lt;activity android:name=&quot;.MainActivity&quot;&gt;</span><br><span class="line">            &lt;intent-filter&gt;</span><br><span class="line">                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line"></span><br><span class="line">                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">            &lt;/intent-filter&gt;</span><br><span class="line">        &lt;/activity&gt;</span><br><span class="line">        &lt;activity</span><br><span class="line">            android:taskAffinity=&quot;com.xiao.x&quot;</span><br><span class="line">            android:name=&quot;.SecondActivity&quot;</span><br><span class="line">            android:label=&quot;@string/title_activity_second&quot;</span><br><span class="line">            android:launchMode=&quot;singleTask&quot;</span><br><span class="line">            android:theme=&quot;@style/AppTheme.NoActionBar&quot; /&gt;</span><br><span class="line">        &lt;activity</span><br><span class="line">            android:name=&quot;.ThirdActivity&quot;</span><br><span class="line">            android:taskAffinity=&quot;com.xiao.x&quot;</span><br><span class="line">            android:launchMode=&quot;singleTask&quot;</span><br><span class="line">            android:label=&quot;@string/title_activity_third&quot;</span><br><span class="line">            android:theme=&quot;@style/AppTheme.NoActionBar&quot;&gt;&lt;/activity&gt;</span><br><span class="line">    &lt;/application&gt;</span><br><span class="line"></span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure></p>
<p>这里将SecondActivity和ThirdActivity设置为singleTask，并且taskAffinity设置为com.xiao.x，假定MainActivity为A，SecondActivity为B，ThirdActivity为C，然后A启动B，B启动C，C启动B。<br>先分析一下。<br>A是Standard模式。所以A启动B的时候，由于B是singleTask并且taskAffinity是com.xiao.x，这个时候com.xiao.x任务栈不存在，就会创建这个任务栈，然后B启动C，C的taskAffinity是com.xiao.x，已经存在，只需要创建一个C放入com.xiao.x这个任务栈中<br>看一下 dumpsys activity的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Stack #1:</span><br><span class="line"> mFullscreen=true</span><br><span class="line"> mBounds=null</span><br><span class="line">   Task id #2248</span><br><span class="line">   mFullscreen=true</span><br><span class="line">   mBounds=null</span><br><span class="line">   mMinWidth=-1</span><br><span class="line">   mMinHeight=-1</span><br><span class="line">   mLastNonFullscreenBounds=null</span><br><span class="line">     TaskRecord&#123;520a424 #2248 A=com.xiao.x U=0 StackId=1 sz=2&#125;</span><br><span class="line">     Intent &#123; flg=0x10000000 cmp=com.smart.kaifa/.SecondActivity &#125;</span><br><span class="line">       Hist #1: ActivityRecord&#123;bcfad93 u0 com.smart.kaifa/.ThirdActivity t2248&#125;</span><br><span class="line">         Intent &#123; flg=0x10000000 cmp=com.smart.kaifa/.ThirdActivity &#125;</span><br><span class="line">         ProcessRecord&#123;7c51142 28971:com.smart.kaifa/u0a190&#125;</span><br><span class="line">       Hist #0: ActivityRecord&#123;5fe4c2b u0 com.smart.kaifa/.SecondActivity t2248&#125;</span><br><span class="line">         Intent &#123; flg=0x10000000 cmp=com.smart.kaifa/.SecondActivity &#125;</span><br><span class="line">         ProcessRecord&#123;7c51142 28971:com.smart.kaifa/u0a190&#125;</span><br><span class="line">   Task id #2246</span><br><span class="line">   mFullscreen=true</span><br><span class="line">   mBounds=null</span><br><span class="line">   mMinWidth=-1</span><br><span class="line">   mMinHeight=-1</span><br><span class="line">   mLastNonFullscreenBounds=null</span><br><span class="line">     TaskRecord&#123;8c10b8d #2246 A=com.smart.kaifa U=0 StackId=1 sz=1&#125;</span><br><span class="line">     Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] flg=0x10000000 cmp=com.smart.kaifa/.MainActivity &#125;</span><br><span class="line">       Hist #0: ActivityRecord&#123;e2d5234 u0 com.smart.kaifa/.MainActivity t2246&#125;</span><br><span class="line">         Intent &#123; act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] flg=0x10000000 cmp=com.smart.kaifa/.MainActivity &#125;</span><br><span class="line">         ProcessRecord&#123;7c51142 28971:com.smart.kaifa/u0a190&#125;</span><br><span class="line"></span><br><span class="line">   Running activities (most recent first):</span><br><span class="line">     TaskRecord&#123;520a424 #2248 A=com.xiao.x U=0 StackId=1 sz=2&#125;  //任务栈 com.xiao.x</span><br><span class="line">       Run #2: ActivityRecord&#123;bcfad93 u0 com.smart.kaifa/.ThirdActivity t2248&#125;</span><br><span class="line">       Run #1: ActivityRecord&#123;5fe4c2b u0 com.smart.kaifa/.SecondActivity t2248&#125;</span><br><span class="line">     TaskRecord&#123;8c10b8d #2246 A=com.smart.kaifa U=0 StackId=1 sz=1&#125; //任务栈com.smart.kaifa</span><br><span class="line">       Run #0: ActivityRecord&#123;e2d5234 u0 com.smart.kaifa/.MainActivity t2246&#125;</span><br><span class="line"></span><br><span class="line">   mResumedActivity: ActivityRecord&#123;bcfad93 u0 com.smart.kaifa/.ThirdActivity t2248&#125;</span><br></pre></td></tr></table></figure>
<p>现在对Activity的启动模式有了更加深入的了解</p>
<h2 id="Activity的Flags"><a href="#Activity的Flags" class="headerlink" title="Activity的Flags"></a>Activity的Flags</h2><p>这里主要分析一些比较常用的标志位</p>
<ul>
<li>FLAG_ACTIVITY_NEW_TASK<br>这个标记为的作用是为Activity指定singleTask启动模式，其效果和在XML中指定该启动模式相同</li>
<li>FLAG_ACTIVITY_SINGLE_TOP<br>这个标记位的作用是为activity指定SingleTop启动模式，其效果和在XML中指定该启动模式相同</li>
<li>FLAG_ACTIVITY_CLEAR_TOP<br>具有此标记位的Activity，当他在启动的时候，同一个任务栈中所有位于它上面的Activity都要出栈，这个标记位一般会和singleTask启动模式一起出现，在这种情况下，如果Activity实例已经存在，会调用OnNewIntent，如果被启动的Activity是采用standard模式，那么连同他上面的Activity都要出栈，singleTask默认自带FLAG_ACTIVITY_CLEAR_TOP效果</li>
<li>FLAG_ACTIVITY_EXCLUDE_FROM_DECENTS<br>具有这个标记的Activity不会出现在历史Activity列表中，当某些情况下我们不希望用户通过历史列表回到我们的Activity的时候这个标记比较有用，他等同于在XML中指定Activity的属性<code>android:excludeFromRecents=true</code></li>
</ul>
<h1 id="Intent的匹配规则"><a href="#Intent的匹配规则" class="headerlink" title="Intent的匹配规则"></a>Intent的匹配规则</h1><p>Activity的启动分为两种，显示调用和隐式调用。隐式调用最主要是通过IntentFilter中设置过滤信息，只有匹配过滤信息才能启动Activity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;activity android:name=&quot;.MainActivity&quot;&gt;</span><br><span class="line">       &lt;intent-filter&gt;</span><br><span class="line">           &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line"></span><br><span class="line">           &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">       &lt;/intent-filter&gt;</span><br><span class="line">   &lt;/activity&gt;</span><br><span class="line">   &lt;activity</span><br><span class="line">       android:name=&quot;.SecondActivity&quot;</span><br><span class="line">       android:label=&quot;@string/title_activity_second&quot;</span><br><span class="line">       android:launchMode=&quot;singleTask&quot;</span><br><span class="line">       android:taskAffinity=&quot;com.xiao.x&quot;</span><br><span class="line">       android:theme=&quot;@style/AppTheme.NoActionBar&quot;&gt;</span><br><span class="line"></span><br><span class="line">       &lt;intent-filter&gt;</span><br><span class="line">           &lt;category android:name=&quot;android.intent.category.DEFAULT&quot;/&gt;</span><br><span class="line">           &lt;action android:name=&quot;com.xxx&quot; /&gt;</span><br><span class="line">           &lt;action android:name=&quot;com.xiao&quot; /&gt;</span><br><span class="line">           &lt;category android:name=&quot;com.xxzz&quot; /&gt;</span><br><span class="line">           &lt;data android:mimeType=&quot;text/plain&quot; /&gt;</span><br><span class="line">       &lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure>
<p>为了匹配过滤列表，需要同时匹配过滤列表中的action,category,data信息，否则匹配失败，一个过滤列表中的action，category和data可以有多个，所有的action，category，data分别构成不同的类别，同一个类别的信息共同约束当前类别的匹配过程，只有一个Intent同时匹配action类别，category类别，data类别才算完全匹配，只有完全匹配成功才能成功启动目标Activity。另外一点，一个Activity中可以有多个intent-filter，一个intent只要能匹配任何一组intent-filter即可成功启动对应的Activity。</p>
<p>规则匹配详情</p>
<ul>
<li><p>action的匹配规则<br>action是一个字符串，系统预定义了一些action，同时我们也可以在应用中自定义action，action的匹配规则就是Intent中的aciton必须能够和过滤规则中的action匹配，这里的匹配指的是action的字符串值完全一样。一个过滤规则中可以有多个action，那么只要Intent中的action中能够与过滤规则中任何一个action相同，即可匹配成功。针对上面的过滤规则，只要我们的Intent中的action为com.xxx或者为com.xiao就可以匹配成功。需要注意的是如果Intent中没有指定action，那么匹配失败。总结一下就是action的匹配要求Intent中的action存在且必须和过滤规则中的其中一个action相同，这里需要注意他和category匹配过着的不同，另外，action区分大小写</p>
</li>
<li><p>category匹配规则<br>category是一个字符串，系统已经预定义了一些category，同时我们也可以在应用中自动自category。category的匹配规则和action不同，他要求Intent中如果含有category，那么所有的category都必须和过滤规则中的其中一个category相同。换句话说，Intent中如果出现了category，不管有几个category，对于每个category来讲，它必须是过滤规则中已经定义了的category。当然，Intent中可以没有category，如果没有category的话，按照上面的描述。这个Intent任然可以匹配成功。注意他和action的区别，action是只要有一个满足就可以，而category必须是都要满足。那么为什么不设置category也可以匹配成功呢？原因是系统在startActivity的时候或者startActivityForResult的时候会默认为加上Intent加上”android.intent.category.DEFAULT”这个category，所以这个category就可以匹配前面的过滤规则中的第一个。同时为了我们隐式调用，要在intent-filter中添加一个category。</p>
</li>
<li><p>data的匹配规则<br>data的匹配规则和action类似，如果过滤规则中定义了data，那么Intent中必须也要定义可匹配的data。在介绍匹配规则之前，县来讲一下data的结构，这个有点复杂</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">     android:name=&quot;.SecondActivity&quot;</span><br><span class="line">     android:label=&quot;@string/title_activity_second&quot;</span><br><span class="line">     android:launchMode=&quot;singleTask&quot;</span><br><span class="line">     android:taskAffinity=&quot;com.xiao.x&quot;</span><br><span class="line">     android:theme=&quot;@style/AppTheme.NoActionBar&quot;&gt;</span><br><span class="line"></span><br><span class="line">     &lt;intent-filter&gt;</span><br><span class="line">         &lt;data</span><br><span class="line">             android:scheme=&quot;string&quot;</span><br><span class="line">             android:host=&quot;string&quot;</span><br><span class="line">             android:port=&quot;string&quot;</span><br><span class="line">             android:path=&quot;string&quot;</span><br><span class="line">             android:pathPattern=&quot;string&quot;</span><br><span class="line">             android:pathPrefix=&quot;string&quot;</span><br><span class="line"></span><br><span class="line">             android:mimeType=&quot;string&quot; /&gt;</span><br><span class="line">     &lt;/intent-filter&gt;</span><br><span class="line"> &lt;/activity&gt;</span><br></pre></td></tr></table></figure>
<p>data由两部分组成，mimeType和URI。mimeType指媒体类型，比如image/jpeg audio/mpeg4-generic和video/* 等，可以表示图片，文本，视频等不同的媒体格式，而URI中包含的数据就比较多了，下面是URI的结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;/[&lt;path&gt;|&lt;pathPrefix&gt;|&lt;pathPattern&gt;]</span><br></pre></td></tr></table></figure>
<p>这里在结合一个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content://com.example.project:200/folder/subfoder/etc</span><br><span class="line">http://www.baidu.com:80/search/info</span><br></pre></td></tr></table></figure>
<p>这个其实就是一个类似网址的结果</p>
<table>
<thead>
<tr>
<th>英文</th>
<th style="text-align:center">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>scheme</td>
<td style="text-align:center">URI的模式，比如Http、file、content等,如果RUI中没有指定scheme，那么整个URI的其他参数无效，这意味着整个URI无效</td>
</tr>
<tr>
<td>Host</td>
<td style="text-align:center">URI的主机名，比如<a href="http://www.baidu.com,如果host未指定,那么整个URI中的其他参数无效，这也意味着URI是无效的" target="_blank" rel="noopener">www.baidu.com,如果host未指定,那么整个URI中的其他参数无效，这也意味着URI是无效的</a></td>
</tr>
<tr>
<td>Port</td>
<td style="text-align:center">URI的端口号，比如80，仅当URI中指定了scheme和host参数的时候，post参数才是有意义的</td>
</tr>
<tr>
<td>path</td>
<td style="text-align:center">是描述路径信息的。表示完整路径信息</td>
</tr>
<tr>
<td>pathPrefix</td>
<td style="text-align:center">表示完整路径信息，但是他里面可以包含通配符<em> ，</em>表示0个或者多个任意字符，需要注意的是，由于正则表达式的规范，如果想表示真是的字符串，要写成\*</td>
</tr>
<tr>
<td>pathPattern</td>
<td style="text-align:center">表示路径的前缀信息</td>
</tr>
</tbody>
</table>
<p>介绍完之后就介绍data的匹配规则了，data匹配规则和action类似，它也要求必须含有data数据，并且data数据能够完全匹配过滤规则中的某一个data，这这里的完全匹配指的是过滤规则中出现的data部分也出现了Intent中的Data中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;activity</span><br><span class="line">    android:name=&quot;.SecondActivity&quot;</span><br><span class="line">    android:label=&quot;@string/title_activity_second&quot;</span><br><span class="line">    android:launchMode=&quot;singleTask&quot;</span><br><span class="line">    android:taskAffinity=&quot;com.xiao.x&quot;</span><br><span class="line">    android:theme=&quot;@style/AppTheme.NoActionBar&quot;&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;data</span><br><span class="line">            android:mimeType=&quot;text/*&quot; /&gt;//</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure>
<p>这种匹配规则制定了媒体类型为所有类型的文字，mimeType属性必须为”text/* “才能匹配，这种情况下虽然规律规则没有指定URI，但是却有默认值，URI的默认值为content和file。也就是说，虽然没有指定URI，但是Intent中URI部分的scheme必须为content或者file才能匹配，这点是需要尤其注意的。为了匹配这个规则，我们可以写出如下示例。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setDataAndType（URI.parse(&quot;file://abc&quot;)，“text/xxx”）</span><br></pre></td></tr></table></figure>
<p>如果要为Intent指定完整的data,必须要调用setDataAndType方法，不能先调用setData在调用setType,因为这两个方法彼此会清除对方的值，这个看源码就很容易理解了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public Intent setData(URI data)&#123;</span><br><span class="line">  mData=data;</span><br><span class="line">  mType=null;</span><br><span class="line">  return this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置过滤规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;activity</span><br><span class="line">    android:name=&quot;.SecondActivity&quot;</span><br><span class="line">    android:label=&quot;@string/title_activity_second&quot;</span><br><span class="line">    android:launchMode=&quot;singleTask&quot;</span><br><span class="line">    android:taskAffinity=&quot;com.xiao.x&quot;</span><br><span class="line">    android:theme=&quot;@style/AppTheme.NoActionBar&quot;&gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;data</span><br><span class="line">          android:scheme=&quot;http&quot; ...</span><br><span class="line">            android:mimeType=&quot;video/mpeg&quot; /&gt;</span><br><span class="line"></span><br><span class="line">            &lt;data</span><br><span class="line">              android:scheme=&quot;http&quot; ...</span><br><span class="line">                android:mimeType=&quot;audio/mpeg&quot; /&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line"></span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure>
<p>这种规则制定了两组data规则，切每个data都制定了完整的属性值，既有URI又有mimeType。为了匹配2中的规则，我们可以写出如下示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setDataAndType（URI.parse(&quot;file://abc&quot;)，“audio/mpeg”）</span><br></pre></td></tr></table></figure>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setDataAndType（URI.parse(&quot;file://abc&quot;)，“video/mpeg”）</span><br></pre></td></tr></table></figure></p>
<p> 通过上面的两个示例，读者应该已经明白了data的匹配规则，关于data还有一个特殊情况需要说明一下，这也是它和action不同的地方，如下两种特殊写法，它们的作用是一样的</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;data</span><br><span class="line">  android:scheme=&quot;file&quot;</span><br><span class="line">    android:host&quot;www.baidu.com&quot;/&gt;</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;data</span><br><span class="line">  android:scheme=&quot;file&quot; /&gt;</span><br><span class="line">      &lt;data    android:host&quot;www.baidu.com&quot;/&gt;</span><br></pre></td></tr></table></figure>
<p>到这里我们已经把IntentFilter的过滤规则都讲解一遍，还记得本节前面给出的一个intent-filter的示例吗，现在我们给出完全匹配他的Intent</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent=new Intent(&quot;com.xiao.x&quot;)</span><br><span class="line">intent.addCategory(&quot;com.xiao.x&quot;)</span><br><span class="line">intent.setDataAndType(URI.parse(&quot;file://abc&quot;),&quot;text/plain&quot;)</span><br><span class="line">startActivity(intent)</span><br></pre></td></tr></table></figure>
<p>这个匹配规则对于Service和BroadcastReceiver是一样的<br>但是对于Service 系统建议使用显示的方式来启动服务</p>
<p>当我们使用隐式方式启动Activity的时候建议做一下判断，看能不能匹配我们的隐式Intent，如果没有就可能会报错 activity no found 。判断有两种方式，第一种是使用packetManager的resolveActivity方法或者Intent的resolveActivity方法，如果找不到Activity，就会返回null。packetManage还提供了另外一种方法，queryIntentActivities 方法，这个方法和resolveActivity不同，他返回所有匹配的activity，这个时候可以通过他过滤activity，然后直接实现应用内跳转。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public abstrace List&lt;resolveInfo&gt; queryIntentActivitys(Intent intent,int flags);</span><br><span class="line">public abstrace resolveInfo  resolveActivity(Intent intent,int flags);</span><br></pre></td></tr></table></figure>
<p>第一个参数是intent，第二个参数要注意，我们要使用MATCH_DEFAULT_ONLY这个标记位，这个标记位的含义是紧紧匹配那些在intent-filter中申明的<code>&lt;category android:name=&quot;android.intent.category.DEFAULT&quot;&gt;</code> 这个category的activity。使用这个标记位的意义是如果两个方法返回值不为null，那么startactivity一定可以成功，如果不使用这个标记位，那么就可以吧intent-filter中category不含DEFAULT的那些匹配出来。从而导致匹配失败，那么category为DEFSULT的那些就无法匹配出来，导致启动失败。因为不还有DEFAULT的这个category的activity无法接受隐式的intent。在action和category中有一类action和category比较重要</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;action android:name=&quot;android.intent.action.MAIN&quot;&gt;</span><br><span class="line">&lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>这个标记了应用的一个入口，二缺一不可，不然无法启动。针对Service和BroadcastReceiver，PackageManager同样提供了类似的方法获取成功匹配的组件的信息</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/进阶/" rel="tag"># 进阶</a>
          
            <a href="/tags/Android开发艺术探索/" rel="tag"># Android开发艺术探索</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/android/Android开发艺术探索_第十二章 Bitmap的加载和Cache/" rel="next" title="Android开发艺术探索 第十二章 Bitmap的加载和Cache">
                <i class="fa fa-chevron-left"></i> Android开发艺术探索 第十二章 Bitmap的加载和Cache
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/android/Android开发艺术探索_第二章 IPC机制/" rel="prev" title="Android开发艺术探索 第二章 IPC机制">
                Android开发艺术探索 第二章 IPC机制 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Groot</p>
              <p class="site-description motion-element" itemprop="description">尽信书则不如无书</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">53</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-的生命周期全面分析"><span class="nav-number">1.</span> <span class="nav-text">Android 的生命周期全面分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#正常情况下的生命周期分析"><span class="nav-number">1.1.</span> <span class="nav-text">正常情况下的生命周期分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常情况下的生命周期方法周期分析"><span class="nav-number">1.2.</span> <span class="nav-text">异常情况下的生命周期方法周期分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#资源相关的系统配置发生改变导致Activity被杀死并重新创建"><span class="nav-number">1.2.0.1.</span> <span class="nav-text">资源相关的系统配置发生改变导致Activity被杀死并重新创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#资源内存不足导致低优先级的Activity被杀死"><span class="nav-number">1.2.0.2.</span> <span class="nav-text">资源内存不足导致低优先级的Activity被杀死</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Activity的启动模式"><span class="nav-number">2.</span> <span class="nav-text">Activity的启动模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity的LaunchMode"><span class="nav-number">2.1.</span> <span class="nav-text">Activity的LaunchMode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Activity的Flags"><span class="nav-number">2.2.</span> <span class="nav-text">Activity的Flags</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Intent的匹配规则"><span class="nav-number">3.</span> <span class="nav-text">Intent的匹配规则</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Groot</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
